<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3代币交互工具</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 自定义样式 -->
    <style>
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .hex-input {
            font-family: monospace;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- 导航栏 -->
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div class="text-xl font-bold">Web3代币交互工具</div>
                <div id="wallet-status" class="text-sm bg-blue-700 px-3 py-1 rounded-full">
                    未连接钱包
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容区 -->
    <div class="container mx-auto px-4 py-8">
        <!-- 标签导航 -->
        <div class="mb-6 border-b border-gray-200">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center">
                <li class="mr-2">
                    <a href="#" class="tab-btn active inline-block p-4 border-b-2 border-blue-600 rounded-t-lg" data-tab="network">网络连接</a>
                </li>
                <li class="mr-2">
                    <a href="#" class="tab-btn inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" data-tab="distribute">代币分发</a>
                </li>
                <li class="mr-2">
                    <a href="#" class="tab-btn inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" data-tab="collect">代币集中</a>
                </li>
                <li class="mr-2">
                    <a href="#" class="tab-btn inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" data-tab="contract">合约交互</a>
                </li>
            </ul>
        </div>

        <!-- 标签内容区 -->
        <div class="tab-content-container">
            <!-- 网络连接区 -->
            <div id="network-tab" class="tab-content active">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">连接到区块链网络</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- 自定义网络配置 -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="font-medium mb-3">自定义网络</h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label for="rpc-url" class="block text-sm font-medium text-gray-700 mb-1">RPC URL</label>
                                    <input type="text" id="rpc-url" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                        placeholder="例如: https://eth-mainnet.alchemyapi.io/v2/your-api-key">
                                </div>
                                
                                <div>
                                    <label for="chain-id" class="block text-sm font-medium text-gray-700 mb-1">链 ID</label>
                                    <input type="number" id="chain-id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                        placeholder="例如: 1 (以太坊主网)">
                                </div>
                                
                                <div>
                                    <label for="network-name" class="block text-sm font-medium text-gray-700 mb-1">网络名称</label>
                                    <input type="text" id="network-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                        placeholder="例如: 以太坊主网">
                                </div>
                                
                                <button id="connect-custom-network" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">
                                    连接到自定义网络
                                </button>
                            </div>
                        </div>
                        
                        <!-- 常用网络 -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="font-medium mb-3">常用网络</h3>
                            
                            <div class="space-y-2">
                                <button class="preset-network w-full text-left px-4 py-3 border border-gray-300 rounded-md hover:bg-gray-100 transition" data-rpc="https://mainnet.infura.io/v3/your-api-key" data-chain-id="1" data-name="以太坊主网">
                                    <span class="font-medium">以太坊主网</span>
                                    <span class="text-xs text-gray-500 block">Chain ID: 1</span>
                                </button>
                                
                                <button class="preset-network w-full text-left px-4 py-3 border border-gray-300 rounded-md hover:bg-gray-100 transition" data-rpc="https://rpc.ankr.com/bsc" data-chain-id="56" data-name="币安智能链">
                                    <span class="font-medium">币安智能链</span>
                                    <span class="text-xs text-gray-500 block">Chain ID: 56</span>
                                </button>
                                
                                <button class="preset-network w-full text-left px-4 py-3 border border-gray-300 rounded-md hover:bg-gray-100 transition" data-rpc="https://polygon-rpc.com" data-chain-id="137" data-name="Polygon">
                                    <span class="font-medium">Polygon</span>
                                    <span class="text-xs text-gray-500 block">Chain ID: 137</span>
                                </button>
                                
                                <button class="preset-network w-full text-left px-4 py-3 border border-gray-300 rounded-md hover:bg-gray-100 transition" data-rpc="https://api.avax.network/ext/bc/C/rpc" data-chain-id="43114" data-name="Avalanche C-Chain">
                                    <span class="font-medium">Avalanche C-Chain</span>
                                    <span class="text-xs text-gray-500 block">Chain ID: 43114</span>
                                </button>
                            </div>
                            
                            <div class="mt-4">
                                <button id="connect-wallet" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">
                                    连接钱包
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 连接状态 -->
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h3 class="font-medium mb-2">连接状态</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">当前网络: <span id="current-network" class="font-medium">未连接</span></p>
                                <p class="text-sm text-gray-600">钱包地址: <span id="wallet-address" class="font-medium">未连接</span></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">链 ID: <span id="current-chain-id" class="font-medium">-</span></p>
                                <p class="text-sm text-gray-600">余额: <span id="wallet-balance" class="font-medium">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 代币分发区 -->
            <div id="distribute-tab" class="tab-content">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">代币批量分发</h2>
                    
                    <div class="space-y-6">
                        <!-- 代币合约信息 -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="font-medium mb-3">代币合约信息</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="token-address" class="block text-sm font-medium text-gray-700 mb-1">代币合约地址</label>
                                    <input type="text" id="token-address" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                        placeholder="0x...">
                                </div>
                                
                                <div>
                                    <label for="token-decimals" class="block text-sm font-medium text-gray-700 mb-1">代币精度</label>
                                    <input type="number" id="token-decimals" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                        placeholder="18" value="18">
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button id="check-token" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md transition duration-200">
                                    检查代币信息
                                </button>
                                
                                <div id="token-info" class="mt-3 hidden">
                                    <p class="text-sm text-gray-600">代币名称: <span id="token-name" class="font-medium">-</span></p>
                                    <p class="text-sm text-gray-600">代币符号: <span id="token-symbol" class="font-medium">-</span></p>
                                    <p class="text-sm text-gray-600">总供应量: <span id="token-supply" class="font-medium">-</span></p>
                                    <p class="text-sm text-gray-600">您的余额: <span id="token-balance" class="font-medium">-</span></p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 批量地址输入 -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="font-medium mb-3">批量接收地址</h3>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">地址列表（每行一个地址，格式：地址,金额）</label>
                                <textarea id="distribute-addresses" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="0x123...,1.5&#10;0x456...,2.3&#10;0x789...,0.8"></textarea>
                                
                                <div class="mt-2 flex justify-between items-center">
                                    <button id="clear-addresses" class="text-sm text-gray-600 hover:text-gray-900">
                                        清空列表
                                    </button>
                                    <button id="import-from-file" class="text-sm text-blue-600 hover:text-blue-800">
                                        从文件导入
                                    </button>
                                    <input type="file" id="address-file" class="hidden" accept=".txt,.csv">
                                </div>
                            </div>
                        </div>
                        
                        <!-- 分发设置 -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="font-medium mb-3">分发设置</h3>
                            
                            <!-- Gas设置部分 -->
                            <div class="mb-4 border-b border-gray-200 pb-4">
                                <h4 class="text-sm font-medium text-gray-700 mb-2">Gas设置</h4>
                                
                                <!-- 当前Gas价格 -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">慢速 (Gwei)</label>
                                        <div class="flex items-center">
                                            <span id="distribute-gas-slow" class="bg-gray-100 px-2 py-1 rounded-md text-gray-800 text-sm w-full">-</span>
                                            <button id="distribute-use-gas-slow" class="ml-1 px-2 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md text-xs">
                                                使用
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">中速 (Gwei)</label>
                                        <div class="flex items-center">
                                            <span id="distribute-gas-medium" class="bg-gray-100 px-2 py-1 rounded-md text-gray-800 text-sm w-full">-</span>
                                            <button id="distribute-use-gas-medium" class="ml-1 px-2 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md text-xs">
                                                使用
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">快速 (Gwei)</label>
                                        <div class="flex items-center">
                                            <span id="distribute-gas-fast" class="bg-gray-100 px-2 py-1 rounded-md text-gray-800 text-sm w-full">-</span>
                                            <button id="distribute-use-gas-fast" class="ml-1 px-2 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md text-xs">
                                                使用
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end mb-3">
                                    <button id="distribute-refresh-gas" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded flex items-center">
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        刷新Gas价格
                                    </button>
                                </div>
                                
                                <!-- Gas设置 -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="gas-price" class="block text-sm font-medium text-gray-700 mb-1">Gas价格 (Gwei)</label>
                                        <input type="number" id="gas-price" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                            placeholder="5" value="5" step="0.1" min="0">
                                    </div>
                                    
                                    <div>
                                        <label for="gas-limit" class="block text-sm font-medium text-gray-700 mb-1">Gas限制</label>
                                        <input type="number" id="gas-limit" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                            placeholder="100000" value="100000">
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <label for="distribute-gas-adjustment" class="block text-sm font-medium text-gray-700 mb-1">Gas价格调整百分比</label>
                                    <div class="flex items-center">
                                        <input type="range" id="distribute-gas-adjustment" min="-50" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                        <span id="distribute-gas-adjustment-value" class="ml-2 min-w-[60px] text-center text-sm">0%</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">调整范围: -50% 到 +100%</p>
                                </div>
                                
                                <div class="mt-2">
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" id="distribute-auto-adjust-gas" class="rounded text-blue-600 focus:ring-blue-500" checked>
                                        <span class="text-sm text-gray-700">自动调整Gas价格（根据网络拥堵情况）</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- 并发设置 -->
                            <div>
                                <h4 class="text-sm font-medium text-gray-700 mb-2">并发设置</h4>
                                <label for="thread-count" class="block text-sm font-medium text-gray-700 mb-1">并发线程数</label>
                                <input type="range" id="thread-count" min="1" max="10" value="3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                <div class="flex justify-between text-xs text-gray-600 px-1">
                                    <span>1</span>
                                    <span id="thread-count-value">3</span>
                                    <span>10</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 执行分发 -->
                        <div class="text-center">
                            <button id="start-distribute" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-md transition duration-200">
                                开始分发
                            </button>
                        </div>
                        
                        <!-- 分发进度 -->
                        <div id="distribute-progress" class="hidden bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="font-medium mb-3">分发进度</h3>
                            
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div id="progress-bar" class="bg-green-600 h-4 rounded-full text-xs text-white text-center" style="width: 0%">
                                    0%
                                </div>
                            </div>
                            
                            <div class="mt-3 text-sm">
                                <p>已处理: <span id="processed-count">0</span>/<span id="total-count">0</span></p>
                                <p>成功: <span id="success-count" class="text-green-600">0</span></p>
                                <p>失败: <span id="failed-count" class="text-red-600">0</span></p>
                            </div>
                            
                            <div class="mt-3">
                                <h4 class="font-medium text-sm mb-1">交易记录</h4>
                                <div id="tx-log" class="max-h-40 overflow-y-auto text-xs bg-gray-100 p-2 rounded">
                                    <!-- 交易日志将在这里显示 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 代币集中区 -->
            <div id="collect-tab" class="tab-content">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">代币批量集中</h2>
                    
                    <div class="space-y-6">
                        <!-- 代币合约信息 -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="font-medium mb-3">代币合约信息</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="collect-token-address" class="block text-sm font-medium text-gray-700 mb-1">代币合约地址</label>
                                    <input type="text" id="collect-token-address" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                        placeholder="0x...">
                                </div>
                                
                                <div>
                                    <button id="check-collect-token" class="h-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md transition duration-200">
                                        检查代币信息
                                    </button>
                                </div>
                            </div>
                            
                            <div id="collect-token-info" class="mt-3 hidden">
                                <p class="text-sm text-gray-600">代币名称: <span id="collect-token-name" class="font-medium">-</span></p>
                                <p class="text-sm text-gray-600">代币符号: <span id="collect-token-symbol" class="font-medium">-</span></p>
                            </div>
                        </div>
                        
                        <!-- 目标地址 -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="font-medium mb-3">目标地址（代币将被集中到此地址）</h3>
                            
                            <div>
                                <label for="target-address" class="block text-sm font-medium text-gray-700 mb-1">接收地址</label>
                                <input type="text" id="target-address" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                    placeholder="0x...">
                            </div>
                        </div>
                        
                        <!-- 源地址列表 -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="font-medium mb-3">源地址列表（代币将从这些地址转出）</h3>
                            
                            <div class="mb-4">
                                <div class="flex space-x-4 mb-3">
                                    <label class="flex items-center space-x-2">
                                        <input type="radio" name="import-type" id="import-private-keys" value="private-keys" class="text-blue-600 focus:ring-blue-500" checked>
                                        <span class="text-sm text-gray-700">导入私钥</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="radio" name="import-type" id="import-mnemonic" value="mnemonic" class="text-blue-600 focus:ring-blue-500">
                                        <span class="text-sm text-gray-700">导入助记词</span>
                                    </label>
                                </div>
                                
                                <!-- 私钥导入 -->
                                <div id="private-keys-input" class="import-section">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">地址和私钥列表（每行一个，格式：地址,私钥）</label>
                                    <div class="relative">
                                        <textarea id="collect-addresses" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="0x123...,0x私钥1&#10;0x456...,0x私钥2&#10;0x789...,0x私钥3"></textarea>
                                        <div class="absolute top-0 right-0 p-2 bg-yellow-100 text-yellow-800 text-xs rounded-bl">
                                            私钥信息仅在本地处理，不会上传到任何服务器
                                        </div>
                                    </div>
                                    
                                    <div class="mt-2 flex justify-between items-center">
                                        <button id="clear-collect-addresses" class="text-sm text-gray-600 hover:text-gray-900">
                                            清空列表
                                        </button>
                                        <button id="import-collect-from-file" class="text-sm text-blue-600 hover:text-blue-800">
                                            从文件导入
                                        </button>
                                        <input type="file" id="collect-address-file" class="hidden" accept=".txt,.csv">
                                    </div>
                                </div>
                                
                                <!-- 助记词导入 -->
                                <div id="mnemonic-input" class="import-section hidden">
                                    <div class="mb-3">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">助记词（12-24个单词，空格分隔）</label>
                                        <div class="relative">
                                            <textarea id="mnemonic-phrase" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                placeholder="例如: apple banana cherry ..."></textarea>
                                            <div class="absolute top-0 right-0 p-2 bg-yellow-100 text-yellow-800 text-xs rounded-bl">
                                                助记词仅在本地处理，不会上传到任何服务器
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">密码（可选）</label>
                                        <input type="password" id="mnemonic-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                            placeholder="可选密码">
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">派生路径</label>
                                            <input type="text" id="derivation-path" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                                value="m/44'/60'/0'/0/" placeholder="m/44'/60'/0'/0/">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">生成地址数量</label>
                                            <input type="number" id="address-count" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                                value="5" min="1" max="100">
                                        </div>
                                    </div>
                                    
                                    <button id="generate-addresses" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md transition duration-200">
                                        生成地址
                                    </button>
                                    
                                    <div id="generated-addresses-container" class="mt-3 hidden">
                                        <h4 class="text-sm font-medium mb-2">生成的地址：</h4>
                                        <div id="generated-addresses-list" class="max-h-40 overflow-y-auto text-xs bg-gray-100 p-2 rounded">
                                            <!-- 生成的地址将显示在这里 -->
                                        </div>
                                        
                                        <button id="use-generated-addresses" class="mt-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-md transition duration-200">
                                            使用这些地址
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 集中设置 -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="font-medium mb-3">集中设置</h3>
                            
                            <!-- Gas设置部分 -->
                            <div class="mb-4 border-b border-gray-200 pb-4">
                                <h4 class="text-sm font-medium text-gray-700 mb-2">Gas设置</h4>
                                
                                <!-- 当前Gas价格 -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">慢速 (Gwei)</label>
                                        <div class="flex items-center">
                                            <span id="collect-gas-slow" class="bg-gray-100 px-2 py-1 rounded-md text-gray-800 text-sm w-full">-</span>
                                            <button id="collect-use-gas-slow" class="ml-1 px-2 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md text-xs">
                                                使用
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">中速 (Gwei)</label>
                                        <div class="flex items-center">
                                            <span id="collect-gas-medium" class="bg-gray-100 px-2 py-1 rounded-md text-gray-800 text-sm w-full">-</span>
                                            <button id="collect-use-gas-medium" class="ml-1 px-2 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md text-xs">
                                                使用
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">快速 (Gwei)</label>
                                        <div class="flex items-center">
                                            <span id="collect-gas-fast" class="bg-gray-100 px-2 py-1 rounded-md text-gray-800 text-sm w-full">-</span>
                                            <button id="collect-use-gas-fast" class="ml-1 px-2 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md text-xs">
                                                使用
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end mb-3">
                                    <button id="collect-refresh-gas" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded flex items-center">
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        刷新Gas价格
                                    </button>
                                </div>
                                
                                <!-- Gas设置 -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="collect-gas-price" class="block text-sm font-medium text-gray-700 mb-1">Gas价格 (Gwei)</label>
                                        <input type="number" id="collect-gas-price" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                            placeholder="5" value="5" step="0.1" min="0">
                                    </div>
                                    
                                    <div>
                                        <label for="collect-gas-limit" class="block text-sm font-medium text-gray-700 mb-1">Gas限制</label>
                                        <input type="number" id="collect-gas-limit" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                            placeholder="100000" value="100000">
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <label for="collect-gas-adjustment" class="block text-sm font-medium text-gray-700 mb-1">Gas价格调整百分比</label>
                                    <div class="flex items-center">
                                        <input type="range" id="collect-gas-adjustment" min="-50" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                        <span id="collect-gas-adjustment-value" class="ml-2 min-w-[60px] text-center text-sm">0%</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">调整范围: -50% 到 +100%</p>
                                </div>
                                
                                <div class="mt-2">
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" id="collect-auto-adjust-gas" class="rounded text-blue-600 focus:ring-blue-500" checked>
                                        <span class="text-sm text-gray-700">自动调整Gas价格（根据网络拥堵情况）</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- 集中选项 -->
                            <div>
                                <h4 class="text-sm font-medium text-gray-700 mb-2">集中选项</h4>
                                <label class="flex items-center space-x-2 mb-3">
                                    <input type="checkbox" id="collect-all-tokens" class="rounded text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-700">集中每个地址的全部代币</span>
                                </label>
                                
                                <!-- 并发设置 -->
                                <div class="mt-3">
                                    <h4 class="text-sm font-medium text-gray-700 mb-2">并发设置</h4>
                                    <label for="thread-count" class="block text-sm font-medium text-gray-700 mb-1">并发线程数</label>
                                    <input type="range" id="thread-count" min="1" max="10" value="3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                    <div class="flex justify-between text-xs text-gray-600 px-1">
                                        <span>1</span>
                                        <span id="thread-count-value">3</span>
                                        <span>10</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 执行集中 -->
                        <div class="text-center">
                            <button id="start-collect" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-md transition duration-200">
                                开始集中
                            </button>
                        </div>
                        
                        <!-- 集中进度 -->
                        <div id="collect-progress" class="hidden bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="font-medium mb-3">集中进度</h3>
                            
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div id="collect-progress-bar" class="bg-green-600 h-4 rounded-full text-xs text-white text-center" style="width: 0%">
                                    0%
                                </div>
                            </div>
                            
                            <div class="mt-3 text-sm">
                                <p>已处理: <span id="collect-processed-count">0</span>/<span id="collect-total-count">0</span></p>
                                <p>成功: <span id="collect-success-count" class="text-green-600">0</span></p>
                                <p>失败: <span id="collect-failed-count" class="text-red-600">0</span></p>
                            </div>
                            
                            <div class="mt-3">
                                <h4 class="font-medium text-sm mb-1">交易记录</h4>
                                <div id="collect-tx-log" class="max-h-40 overflow-y-auto text-xs bg-gray-100 p-2 rounded">
                                    <!-- 交易日志将在这里显示 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 合约交互区 -->
            <div id="contract-tab" class="tab-content">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">自定义合约交互</h2>
                    
                    <div class="space-y-6">
                        <!-- 交互类型选择 -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="font-medium mb-3">交互类型</h3>
                            
                            <div class="flex space-x-4 mb-3">
                                <label class="flex items-center space-x-2">
                                    <input type="radio" name="interaction-type" id="interact-contract" value="contract" class="text-blue-600 focus:ring-blue-500" checked>
                                    <span class="text-sm text-gray-700">合约交互</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="radio" name="interaction-type" id="send-eth" value="send-eth" class="text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-700">发送链主币</span>
                                </label>
                            </div>
                            
                            <!-- 合约交互选项 -->
                            <div id="contract-interaction-options">
                                <div>
                                    <label for="contract-address" class="block text-sm font-medium text-gray-700 mb-1">合约地址</label>
                                    <input type="text" id="contract-address" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                        placeholder="0x...">
                                </div>
                                
                                <div class="mt-3">
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" id="contract-payable" class="rounded text-blue-600 focus:ring-blue-500">
                                        <span class="text-sm text-gray-700">发送ETH（调用payable函数）</span>
                                    </label>
                                </div>
                                
                                <div id="eth-amount-container" class="mt-3 hidden">
                                    <label for="eth-amount" class="block text-sm font-medium text-gray-700 mb-1">ETH数量</label>
                                    <input type="number" id="eth-amount" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                        placeholder="0.01" step="0.001" min="0">
                                </div>
                            </div>
                            
                            <!-- 发送链主币选项 -->
                            <div id="send-eth-options" class="hidden">
                                <div>
                                    <label for="recipient-address" class="block text-sm font-medium text-gray-700 mb-1">接收地址</label>
                                    <input type="text" id="recipient-address" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                        placeholder="0x...">
                                </div>
                                
                                <div class="mt-3">
                                    <label for="eth-send-amount" class="block text-sm font-medium text-gray-700 mb-1">发送数量</label>
                                    <input type="number" id="eth-send-amount" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                        placeholder="0.01" step="0.001" min="0">
                                </div>
                                
                                <div class="mt-3">
                                    <label for="eth-data" class="block text-sm font-medium text-gray-700 mb-1">十六进制数据（可选）</label>
                                    <textarea id="eth-data" rows="2" class="hex-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="0x..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ABI解析功能 -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4">
                            <h3 class="font-medium mb-3">ABI解析</h3>
                            
                            <div class="space-y-3">
                                <div>
                                    <label for="contract-abi" class="block text-sm font-medium text-gray-700 mb-1">合约ABI</label>
                                    <textarea id="contract-abi" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder='[{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"},...]'></textarea>
                                </div>
                                
                                <div class="flex space-x-2">
                                    <button id="parse-abi" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md transition duration-200">
                                        解析ABI
                                    </button>
                                    <button id="clear-abi" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-md transition duration-200">
                                        清除
                                    </button>
                                </div>
                                
                                <div id="abi-functions-container" class="hidden">
                                    <label for="abi-functions" class="block text-sm font-medium text-gray-700 mb-1">选择函数</label>
                                    <select id="abi-functions" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">-- 选择函数 --</option>
                                    </select>
                                </div>
                                
                                <div id="function-params-container" class="hidden space-y-2">
                                    <h4 class="text-sm font-medium text-gray-700">函数参数</h4>
                                    <div id="function-params" class="space-y-2">
                                        <!-- 参数输入字段将在这里动态生成 -->
                                    </div>
                                    <button id="encode-function" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-md transition duration-200">
                                        编码函数调用
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 函数选择器 -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="font-medium mb-3">函数选择器</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="function-selector" class="block text-sm font-medium text-gray-700 mb-1">函数选择器（4字节）</label>
                                    <input type="text" id="function-selector" class="hex-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                        placeholder="0x12345678">
                                </div>
                                
                                <div>
                                    <label for="function-signature" class="block text-sm font-medium text-gray-700 mb-1">函数签名</label>
                                    <div class="flex">
                                        <input type="text" id="function-signature" class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                            placeholder="transfer(address,uint256)">
                                        <button id="generate-selector" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-r-md transition duration-200">
                                            生成
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 函数参数 -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="font-medium mb-3">函数参数</h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label for="function-data" class="block text-sm font-medium text-gray-700 mb-1">16进制编码数据</label>
                                    <textarea id="function-data" rows="4" class="hex-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="0x..."></textarea>
                                    <p class="text-xs text-gray-500 mt-1">不包括函数选择器，仅包含参数部分</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Gas设置部分 -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="font-medium mb-3">Gas设置</h3>
                            
                            <!-- 当前Gas价格 -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">慢速 (Gwei)</label>
                                    <div class="flex items-center">
                                        <span id="contract-gas-slow" class="bg-gray-100 px-2 py-1 rounded-md text-gray-800 text-sm w-full">-</span>
                                        <button id="contract-use-gas-slow" class="ml-1 px-2 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md text-xs">
                                            使用
                                        </button>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">中速 (Gwei)</label>
                                    <div class="flex items-center">
                                        <span id="contract-gas-medium" class="bg-gray-100 px-2 py-1 rounded-md text-gray-800 text-sm w-full">-</span>
                                        <button id="contract-use-gas-medium" class="ml-1 px-2 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md text-xs">
                                            使用
                                        </button>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">快速 (Gwei)</label>
                                    <div class="flex items-center">
                                        <span id="contract-gas-fast" class="bg-gray-100 px-2 py-1 rounded-md text-gray-800 text-sm w-full">-</span>
                                        <button id="contract-use-gas-fast" class="ml-1 px-2 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md text-xs">
                                            使用
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end mb-3">
                                <button id="contract-refresh-gas" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded flex items-center">
                                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    刷新Gas价格
                                </button>
                            </div>
                            
                            <!-- Gas设置 -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="gas-price-contract" class="block text-sm font-medium text-gray-700 mb-1">Gas价格 (Gwei)</label>
                                    <input type="number" id="gas-price-contract" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                        placeholder="5" value="5" step="0.1" min="0">
                                </div>
                                
                                <div>
                                    <label for="gas-limit-contract" class="block text-sm font-medium text-gray-700 mb-1">Gas限制</label>
                                    <input type="number" id="gas-limit-contract" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                        placeholder="200000" value="200000">
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <label for="contract-gas-adjustment" class="block text-sm font-medium text-gray-700 mb-1">Gas价格调整百分比</label>
                                <div class="flex items-center">
                                    <input type="range" id="contract-gas-adjustment" min="-50" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                    <span id="contract-gas-adjustment-value" class="ml-2 min-w-[60px] text-center text-sm">0%</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">调整范围: -50% 到 +100%</p>
                            </div>
                            
                            <div class="mt-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="contract-auto-adjust-gas" class="rounded text-blue-600 focus:ring-blue-500" checked>
                                    <span class="text-sm text-gray-700">自动调整Gas价格（根据网络拥堵情况）</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- 执行交互 -->
                        <div class="text-center">
                            <button id="execute-contract" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-md transition duration-200">
                                执行合约交互
                            </button>
                        </div>
                        
                        <!-- 交互结果 -->
                        <div id="contract-result" class="hidden bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="font-medium mb-3">交互结果</h3>
                            
                            <div>
                                <p class="text-sm text-gray-600 mb-2">交易哈希: <span id="tx-hash" class="font-medium">-</span></p>
                                <p class="text-sm text-gray-600 mb-2">状态: <span id="tx-status" class="font-medium">-</span></p>
                                
                                <div class="mt-3">
                                    <h4 class="font-medium text-sm mb-1">返回数据</h4>
                                    <pre id="return-data" class="max-h-40 overflow-y-auto text-xs bg-gray-100 p-2 rounded">-</pre>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 交易历史记录 -->
                        <div class="bg-white rounded-lg shadow p-6 mt-6">
                            <h2 class="text-xl font-semibold mb-4">交易历史记录</h2>
                            
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white border border-gray-200">
                                    <thead>
                                        <tr>
                                            <th class="px-4 py-2 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">时间</th>
                                            <th class="px-4 py-2 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">类型</th>
                                            <th class="px-4 py-2 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">地址</th>
                                            <th class="px-4 py-2 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">数据</th>
                                            <th class="px-4 py-2 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">状态</th>
                                            <th class="px-4 py-2 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tx-history">
                                        <!-- 交易历史记录将在这里动态添加 -->
                                        <tr class="tx-history-empty">
                                            <td colspan="6" class="px-4 py-4 text-center text-gray-500">暂无交易记录</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="mt-4 flex justify-end">
                                <button id="clear-history" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-md transition duration-200">
                                    清除历史记录
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p>© 2025 Web3代币交互工具 | 由 <a href="https://www.letsmagic.cn" class="text-blue-400 hover:underline">超级麦吉</a> 提供支持</p>
        </div>
    </footer>

    <!-- Web3.js -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <!-- BIP39 和 ethereumjs-wallet 用于助记词处理 -->
    <script src="https://cdn.jsdelivr.net/npm/bip39@3.1.0/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethereumjs-wallet@1.0.2/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hdkey@2.1.0/hdkey.min.js"></script>
    
    <script>
        // 全局变量
        let web3;
        let currentAccount = null;
        
        // ERC20代币合约ABI
        const erc20Abi = [
            // 查询代币名称
            {
                "constant": true,
                "inputs": [],
                "name": "name",
                "outputs": [{"name": "", "type": "string"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            // 查询代币符号
            {
                "constant": true,
                "inputs": [],
                "name": "symbol",
                "outputs": [{"name": "", "type": "string"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            // 查询代币精度
            {
                "constant": true,
                "inputs": [],
                "name": "decimals",
                "outputs": [{"name": "", "type": "uint8"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            // 查询代币总供应量
            {
                "constant": true,
                "inputs": [],
                "name": "totalSupply",
                "outputs": [{"name": "", "type": "uint256"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            // 查询账户余额
            {
                "constant": true,
                "inputs": [{"name": "_owner", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"name": "balance", "type": "uint256"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            // 转账
            {
                "constant": false,
                "inputs": [
                    {"name": "_to", "type": "address"},
                    {"name": "_value", "type": "uint256"}
                ],
                "name": "transfer",
                "outputs": [{"name": "", "type": "bool"}],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            // 授权
            {
                "constant": false,
                "inputs": [
                    {"name": "_spender", "type": "address"},
                    {"name": "_value", "type": "uint256"}
                ],
                "name": "approve",
                "outputs": [{"name": "", "type": "bool"}],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            // 查询授权额度
            {
                "constant": true,
                "inputs": [
                    {"name": "_owner", "type": "address"},
                    {"name": "_spender", "type": "address"}
                ],
                "name": "allowance",
                "outputs": [{"name": "", "type": "uint256"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            // 授权转账
            {
                "constant": false,
                "inputs": [
                    {"name": "_from", "type": "address"},
                    {"name": "_to", "type": "address"},
                    {"name": "_value", "type": "uint256"}
                ],
                "name": "transferFrom",
                "outputs": [{"name": "", "type": "bool"}],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            // 转账事件
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "name": "from", "type": "address"},
                    {"indexed": true, "name": "to", "type": "address"},
                    {"indexed": false, "name": "value", "type": "uint256"}
                ],
                "name": "Transfer",
                "type": "event"
            },
            // 授权事件
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "name": "owner", "type": "address"},
                    {"indexed": true, "name": "spender", "type": "address"},
                    {"indexed": false, "name": "value", "type": "uint256"}
                ],
                "name": "Approval",
                "type": "event"
            }
        ];
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化标签页切换功能
            initTabs();
            
            // 初始化Web3
            initWeb3();
            
            // 初始化各功能区事件监听
            initNetworkEvents();
            initDistributeEvents();
            initCollectEvents();
            initContractEvents();
            initGasSettingsEvents();
        });
        
        // 初始化标签页切换
        function initTabs() {
            const tabs = document.querySelectorAll('.tab-btn');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // 移除所有标签的active类
                    tabs.forEach(t => t.classList.remove('active', 'border-blue-600'));
                    tabs.forEach(t => t.classList.add('border-transparent'));
                    
                    // 添加当前标签的active类
                    this.classList.add('active', 'border-blue-600');
                    this.classList.remove('border-transparent');
                    
                    // 隐藏所有标签内容
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // 显示当前标签内容
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId + '-tab').classList.add('active');
                });
            });
        }
        
        // 初始化Web3
        async function initWeb3() {
            // 检查是否有Web3注入
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                console.log('检测到Web3钱包');
                
                // 添加事件监听器
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', handleChainChanged);
                window.ethereum.on('disconnect', handleDisconnect);
                
                // 尝试恢复之前的连接状态
                try {
                    // 检查本地存储中是否有连接状态
                    const savedConnected = localStorage.getItem('walletConnected');
                    if (savedConnected === 'true') {
                        const accounts = await window.ethereum.request({
                            method: 'eth_accounts'
                        });
                        if (accounts.length > 0) {
                            handleAccountsChanged(accounts);
                            console.log('恢复了之前的钱包连接');
                        }
                    }
                } catch (error) {
                    console.error('恢复钱包状态失败:', error);
                }
            } else if (window.web3) {
                web3 = new Web3(window.web3.currentProvider);
                console.log('检测到旧版Web3钱包');
            } else {
                console.log('未检测到Web3钱包，请安装MetaMask或其他Web3钱包');
                
                // 显示钱包安装提示
                showWalletInstallPrompt();
            }
        }
        
        // 显示钱包安装提示
        function showWalletInstallPrompt() {
            const networkTab = document.getElementById('network-tab');
            const warningDiv = document.createElement('div');
            warningDiv.className = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 my-4';
            warningDiv.innerHTML = `
                <p class="font-bold">未检测到Web3钱包</p>
                <p>请安装 MetaMask 或其他兼容的 Web3 钱包以使用完整功能。</p>
                <a href="https://metamask.io/download/" target="_blank" class="text-blue-600 hover:underline mt-2 inline-block">
                    下载 MetaMask
                </a>
            `;
            networkTab.insertBefore(warningDiv, networkTab.firstChild);
        }
        
        // 处理钱包断开连接
        function handleDisconnect(error) {
            console.log('钱包断开连接', error);
            currentAccount = null;
            updateWalletStatus('未连接钱包', 'bg-blue-700');
            localStorage.removeItem('walletConnected');
        }
        
        // 处理账户变化
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                currentAccount = null;
                updateWalletStatus('未连接钱包', 'bg-blue-700');
                localStorage.removeItem('walletConnected');
                
                // 更新连接状态显示
                document.getElementById('current-network').textContent = '未连接';
                document.getElementById('wallet-address').textContent = '未连接';
                document.getElementById('current-chain-id').textContent = '-';
                document.getElementById('wallet-balance').textContent = '-';
            } else if (accounts[0] !== currentAccount) {
                currentAccount = accounts[0];
                updateWalletStatus(formatAddress(currentAccount), 'bg-green-600');
                localStorage.setItem('walletConnected', 'true');
                updateWalletInfo();
                
                // 显示完整地址的工具提示
                const walletAddressElem = document.getElementById('wallet-address');
                if (walletAddressElem) {
                    walletAddressElem.title = accounts[0];
                }
            }
        }
        
        // 处理链变化
        async function handleChainChanged(chainId) {
            console.log('网络已切换:', parseInt(chainId, 16));
            
            // 更新当前链ID显示
            try {
                const numericChainId = parseInt(chainId, 16);
                document.getElementById('current-chain-id').textContent = numericChainId;
                
                // 更新网络名称显示
                let networkName = getNetworkName(numericChainId);
                document.getElementById('current-network').textContent = networkName;
                
                // 如果钱包已连接，更新余额信息
                if (currentAccount) {
                    const balance = await web3.eth.getBalance(currentAccount);
                    const ethBalance = web3.utils.fromWei(balance, 'ether');
                    document.getElementById('wallet-balance').textContent = parseFloat(ethBalance).toFixed(4) + ' ETH';
                }
                
                // 显示网络切换通知
                showNotification(`已切换到 ${networkName}`, 'success');
            } catch (error) {
                console.error('处理链变化时出错:', error);
                showNotification('网络切换时发生错误', 'error');
            }
        }
        
        // 获取网络名称
        function getNetworkName(chainId) {
            let networkName = '未知网络';
            switch (chainId) {
                case 1: networkName = '以太坊主网'; break;
                case 5: networkName = 'Goerli测试网'; break;
                case 11155111: networkName = 'Sepolia测试网'; break;
                case 56: networkName = '币安智能链'; break;
                case 97: networkName = '币安测试网'; break;
                case 137: networkName = 'Polygon'; break;
                case 80001: networkName = 'Mumbai测试网'; break;
                case 43114: networkName = 'Avalanche C-Chain'; break;
                case 43113: networkName = 'Avalanche Fuji测试网'; break;
                case 42161: networkName = 'Arbitrum One'; break;
                case 421613: networkName = 'Arbitrum Goerli测试网'; break;
                case 10: networkName = 'Optimism'; break;
                case 420: networkName = 'Optimism Goerli测试网'; break;
                default: networkName = '自定义网络 (' + chainId + ')';
            }
            return networkName;
        }
        
        // 更新钱包状态显示
        function updateWalletStatus(text, bgClass) {
            const walletStatus = document.getElementById('wallet-status');
            walletStatus.textContent = text;
            walletStatus.className = 'text-sm px-3 py-1 rounded-full text-white ' + bgClass;
        }
        
        // 显示通知
        function showNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            
            // 设置样式根据类型
            let bgColor = 'bg-blue-500';
            if (type === 'success') bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'warning') bgColor = 'bg-yellow-500';
            
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-2 rounded-md shadow-lg z-50 transition-opacity duration-300`;
            notification.style.opacity = '0';
            notification.textContent = message;
            
            // 添加到文档
            document.body.appendChild(notification);
            
            // 显示通知
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 10);
            
            // 3秒后隐藏通知
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // 格式化地址显示
        function formatAddress(address) {
            if (!address) return '';
            return address.substring(0, 6) + '...' + address.substring(address.length - 4);
        }
        
        // 更新钱包信息
        async function updateWalletInfo() {
            if (!web3 || !currentAccount) return;
            
            try {
                // 获取余额
                const balance = await web3.eth.getBalance(currentAccount);
                const ethBalance = web3.utils.fromWei(balance, 'ether');
                
                // 获取当前链ID
                const chainId = await web3.eth.getChainId();
                
                // 更新显示
                document.getElementById('current-chain-id').textContent = chainId;
                document.getElementById('wallet-balance').textContent = parseFloat(ethBalance).toFixed(4) + ' ETH';
                document.getElementById('wallet-address').textContent = formatAddress(currentAccount);
                
                // 设置地址工具提示
                document.getElementById('wallet-address').title = currentAccount;
                
                // 获取并显示网络名称
                const networkName = getNetworkName(chainId);
                document.getElementById('current-network').textContent = networkName;
                
                return { chainId, balance, networkName };
            } catch (error) {
                console.error('获取钱包信息失败:', error);
                showNotification('获取钱包信息失败: ' + error.message, 'error');
                return null;
            }
        }
        
        // 初始化网络连接区事件
        function initNetworkEvents() {
            // 连接钱包按钮
            document.getElementById('connect-wallet').addEventListener('click', async function() {
                if (!web3) {
                    showNotification('未检测到Web3钱包，请安装MetaMask或其他Web3钱包', 'error');
                    return;
                }
                
                // 显示连接中状态
                const originalText = this.textContent;
                this.innerHTML = '<span class="loading mr-2"></span>连接中...';
                this.disabled = true;
                
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    handleAccountsChanged(accounts);
                    showNotification('钱包连接成功', 'success');
                } catch (error) {
                    console.error('连接钱包失败:', error);
                    showNotification('连接钱包失败: ' + error.message, 'error');
                } finally {
                    // 恢复按钮状态
                    this.innerHTML = originalText;
                    this.disabled = false;
                }
            });
            
            // 断开钱包连接按钮（添加一个新按钮）
            const disconnectBtn = document.createElement('button');
            disconnectBtn.id = 'disconnect-wallet';
            disconnectBtn.className = 'w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-md transition duration-200 mt-2';
            disconnectBtn.textContent = '断开钱包连接';
            disconnectBtn.addEventListener('click', function() {
                if (currentAccount) {
                    // 清除连接状态
                    currentAccount = null;
                    localStorage.removeItem('walletConnected');
                    updateWalletStatus('未连接钱包', 'bg-blue-700');
                    
                    // 更新UI
                    document.getElementById('current-network').textContent = '未连接';
                    document.getElementById('wallet-address').textContent = '未连接';
                    document.getElementById('current-chain-id').textContent = '-';
                    document.getElementById('wallet-balance').textContent = '-';
                    
                    showNotification('已断开钱包连接', 'info');
                }
            });
            
            // 添加断开连接按钮到DOM
            const connectWalletBtn = document.getElementById('connect-wallet');
            connectWalletBtn.parentNode.appendChild(disconnectBtn);
            
            // 连接自定义网络按钮
            document.getElementById('connect-custom-network').addEventListener('click', async function() {
                const rpcUrl = document.getElementById('rpc-url').value.trim();
                const chainId = parseInt(document.getElementById('chain-id').value.trim());
                const networkName = document.getElementById('network-name').value.trim();
                
                if (!rpcUrl || isNaN(chainId) || !networkName) {
                    showNotification('请填写完整的网络信息', 'warning');
                    return;
                }
                
                if (!currentAccount) {
                    showNotification('请先连接钱包', 'warning');
                    return;
                }
                
                // 显示连接中状态
                const originalText = this.textContent;
                this.innerHTML = '<span class="loading mr-2"></span>连接中...';
                this.disabled = true;
                
                try {
                    // 尝试添加自定义网络
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x' + chainId.toString(16),
                            chainName: networkName,
                            nativeCurrency: {
                                name: 'ETH',
                                symbol: 'ETH',
                                decimals: 18
                            },
                            rpcUrls: [rpcUrl]
                        }]
                    });
                    
                    // 更新Web3提供者
                    web3.setProvider(new Web3.providers.HttpProvider(rpcUrl));
                    
                    // 更新UI
                    showNotification('成功连接到自定义网络', 'success');
                    updateWalletInfo();
                } catch (error) {
                    console.error('连接自定义网络失败:', error);
                    showNotification('连接自定义网络失败: ' + error.message, 'error');
                } finally {
                    // 恢复按钮状态
                    this.innerHTML = originalText;
                    this.disabled = false;
                }
            });
            
            // 预设网络按钮
            document.querySelectorAll('.preset-network').forEach(button => {
                button.addEventListener('click', async function() {
                    if (!currentAccount) {
                        showNotification('请先连接钱包', 'warning');
                        return;
                    }
                    
                    const rpcUrl = this.getAttribute('data-rpc');
                    const chainId = parseInt(this.getAttribute('data-chain-id'));
                    const networkName = this.getAttribute('data-name');
                    
                    // 显示切换中状态
                    const originalHtml = this.innerHTML;
                    const networkNameSpan = this.querySelector('.font-medium');
                    const originalNetworkName = networkNameSpan ? networkNameSpan.textContent : '';
                    if (networkNameSpan) {
                        networkNameSpan.innerHTML = '<span class="loading mr-2"></span>切换中...';
                    }
                    this.disabled = true;
                    
                    try {
                        // 尝试切换到指定网络
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x' + chainId.toString(16) }],
                        });
                        
                        // 更新Web3提供者
                        web3.setProvider(new Web3.providers.HttpProvider(rpcUrl));
                        
                        // 更新UI
                        showNotification('成功切换到' + networkName, 'success');
                        updateWalletInfo();
                    } catch (error) {
                        // 如果网络不存在，尝试添加
                        if (error.code === 4902) {
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: '0x' + chainId.toString(16),
                                        chainName: networkName,
                                        nativeCurrency: {
                                            name: 'ETH',
                                            symbol: 'ETH',
                                            decimals: 18
                                        },
                                        rpcUrls: [rpcUrl]
                                    }]
                                });
                                
                                // 更新Web3提供者
                                web3.setProvider(new Web3.providers.HttpProvider(rpcUrl));
                                
                                // 更新UI
                                showNotification('成功连接到' + networkName, 'success');
                                updateWalletInfo();
                            } catch (addError) {
                                console.error('添加网络失败:', addError);
                                showNotification('添加网络失败: ' + addError.message, 'error');
                            }
                        } else {
                            console.error('切换网络失败:', error);
                            showNotification('切换网络失败: ' + error.message, 'error');
                        }
                    } finally {
                        // 恢复按钮状态
                        if (networkNameSpan) {
                            networkNameSpan.textContent = originalNetworkName;
                        } else {
                            this.innerHTML = originalHtml;
                        }
                        this.disabled = false;
                    }
                });
            });
            
            // 添加复制地址按钮
            const statusDiv = document.querySelector('.mt-6.p-4.bg-gray-50.rounded-lg.border.border-gray-200');
            const copyBtn = document.createElement('button');
            copyBtn.className = 'text-sm bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded ml-2 transition';
            copyBtn.textContent = '复制地址';
            copyBtn.addEventListener('click', function() {
                if (currentAccount) {
                    navigator.clipboard.writeText(currentAccount)
                        .then(() => showNotification('地址已复制到剪贴板', 'success'))
                        .catch(err => showNotification('复制失败: ' + err, 'error'));
                } else {
                    showNotification('未连接钱包', 'warning');
                }
            });
            
            const walletAddressP = document.getElementById('wallet-address').parentElement;
            walletAddressP.appendChild(copyBtn);
        }
        
        // 初始化代币分发区事件
        function initDistributeEvents() {
            // 检查代币按钮
            document.getElementById('check-token').addEventListener('click', async function() {
                const tokenAddress = document.getElementById('token-address').value.trim();
                
                // 验证地址格式
                if (!tokenAddress || !web3.utils.isAddress(tokenAddress)) {
                    showNotification('请输入有效的代币合约地址', 'error');
                    return;
                }
                
                // 检查钱包连接状态
                if (!currentAccount) {
                    showNotification('请先连接钱包', 'warning');
                    return;
                }
                
                // 显示加载状态
                const originalText = this.textContent;
                this.innerHTML = '<span class="loading mr-2"></span>检查中...';
                this.disabled = true;
                
                try {
                    // 创建ERC20代币合约实例
                    const tokenContract = new web3.eth.Contract(erc20Abi, tokenAddress);
                    
                    // 并行获取代币信息
                    const [name, symbol, decimalsResult, totalSupply, balance] = await Promise.all([
                        tokenContract.methods.name().call(),
                        tokenContract.methods.symbol().call(),
                        tokenContract.methods.decimals().call(),
                        tokenContract.methods.totalSupply().call(),
                        tokenContract.methods.balanceOf(currentAccount).call()
                    ]);
                    
                    // 保存代币精度
                    const decimals = parseInt(decimalsResult);
                    document.getElementById('token-decimals').value = decimals;
                    
                    // 格式化总供应量和余额，考虑代币精度
                    const divisor = new web3.utils.BN(10).pow(new web3.utils.BN(decimals));
                    const formattedTotalSupply = new web3.utils.BN(totalSupply).div(divisor).toString();
                    const formattedBalance = new web3.utils.BN(balance).div(divisor).toString();
                    
                    // 更新UI显示
                    document.getElementById('token-name').textContent = name;
                    document.getElementById('token-symbol').textContent = symbol;
                    document.getElementById('token-supply').textContent = formattedTotalSupply + ' ' + symbol;
                    document.getElementById('token-balance').textContent = formattedBalance + ' ' + symbol;
                    
                    // 显示代币信息区域
                    document.getElementById('token-info').classList.remove('hidden');
                    
                    // 保存当前代币合约实例供后续使用
                    window.currentTokenContract = tokenContract;
                    
                    showNotification(`成功获取代币 ${name} (${symbol}) 信息`, 'success');
                } catch (error) {
                    console.error('获取代币信息失败:', error);
                    showNotification('获取代币信息失败: ' + (error.message || '无效的ERC20代币合约'), 'error');
                } finally {
                    // 恢复按钮状态
                    this.innerHTML = originalText;
                    this.disabled = false;
                }
            });
            
            // 清空地址列表按钮
            document.getElementById('clear-addresses').addEventListener('click', function() {
                document.getElementById('distribute-addresses').value = '';
            });
            
            // 从文件导入按钮
            document.getElementById('import-from-file').addEventListener('click', function() {
                document.getElementById('address-file').click();
            });
            
            // 文件选择变化
            document.getElementById('address-file').addEventListener('change', function(e) {
                if (!e.target.files || e.target.files.length === 0) {
                    return;
                }
                
                const file = e.target.files[0];
                const fileType = file.name.split('.').pop().toLowerCase();
                
                // 检查文件类型
                if (fileType !== 'txt' && fileType !== 'csv') {
                    showNotification('请选择.txt或.csv格式的文件', 'error');
                    return;
                }
                
                // 显示正在处理通知
                showNotification('正在读取文件...', 'info');
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const content = event.target.result;
                        const lines = content.split(/\r?\n/).filter(line => line.trim());
                        
                        // 验证和解析每一行
                        const validLines = [];
                        const invalidLines = [];
                        
                        lines.forEach((line, index) => {
                            // 尝试解析地址和金额
                            const parts = line.trim().split(',');
                            
                            if (parts.length !== 2) {
                                invalidLines.push({line: index + 1, content: line, reason: '格式错误，应为"地址,金额"'});
                                return;
                            }
                            
                            const [address, amount] = parts.map(p => p.trim());
                            
                            // 验证地址格式
                            if (!isValidEthereumAddress(address)) {
                                invalidLines.push({line: index + 1, content: line, reason: '无效的以太坊地址'});
                                return;
                            }
                            
                            // 验证金额格式
                            const decimals = parseInt(document.getElementById('token-decimals').value) || 18;
                            const amountResult = parseTokenAmount(amount, decimals);
                            if (!amountResult.valid) {
                                invalidLines.push({line: index + 1, content: line, reason: '无效的金额: ' + amountResult.error});
                                return;
                            }
                            
                            // 添加到有效行
                            validLines.push(line);
                        });
                        
                        // 显示结果
                        if (invalidLines.length > 0) {
                            let errorMsg = `文件中有${invalidLines.length}行数据无效:\n`;
                            invalidLines.slice(0, 5).forEach(item => {
                                errorMsg += `第${item.line}行: ${item.reason}\n`;
                            });
                            
                            if (invalidLines.length > 5) {
                                errorMsg += `...以及其他${invalidLines.length - 5}行\n`;
                            }
                            
                            showNotification(errorMsg, 'warning');
                        }
                        
                        if (validLines.length > 0) {
                            // 更新文本区域内容
                            const textarea = document.getElementById('distribute-addresses');
                            textarea.value = validLines.join('\n');
                            
                            showNotification(`成功导入${validLines.length}个有效地址`, 'success');
                        } else {
                            showNotification('没有找到有效的地址和金额', 'error');
                        }
                    } catch (error) {
                        console.error('解析文件失败:', error);
                        showNotification('解析文件失败: ' + error.message, 'error');
                    }
                };
                
                reader.onerror = function() {
                    showNotification('读取文件失败', 'error');
                };
                
                reader.readAsText(file);
                
                // 清空文件输入，允许重复选择同一个文件
                e.target.value = '';
            });
            
            // 线程数滑块变化
            document.getElementById('thread-count').addEventListener('input', function() {
                document.getElementById('thread-count-value').textContent = this.value;
            });
            
            // 开始分发按钮
            document.getElementById('start-distribute').addEventListener('click', async function() {
                // 检查钱包连接状态
                if (!currentAccount) {
                    showNotification('请先连接钱包', 'warning');
                    return;
                }
                
                // 检查代币合约
                const tokenAddress = document.getElementById('token-address').value.trim();
                if (!tokenAddress || !web3.utils.isAddress(tokenAddress)) {
                    showNotification('请输入有效的代币合约地址', 'error');
                    return;
                }
                
                // 获取并验证地址列表
                const addressesText = document.getElementById('distribute-addresses').value.trim();
                if (!addressesText) {
                    showNotification('请输入接收地址和金额', 'warning');
                    return;
                }
                
                // 解析地址和金额
                const lines = addressesText.split(/\r?\n/).filter(line => line.trim());
                if (lines.length === 0) {
                    showNotification('没有找到有效的地址和金额', 'error');
                    return;
                }
                
                // 验证每一行并创建任务列表
                const tasks = [];
                const invalidLines = [];
                let totalAmount = web3.utils.toBN(0);
                
                // 获取代币精度
                const decimals = parseInt(document.getElementById('token-decimals').value) || 18;
                const multiplier = web3.utils.toBN(10).pow(web3.utils.toBN(decimals));
                
                lines.forEach((line, index) => {
                    const parts = line.trim().split(',');
                    if (parts.length !== 2) {
                        invalidLines.push({line: index + 1, content: line, reason: '格式错误，应为"地址,金额"'});
                        return;
                    }
                    
                    const [address, amountStr] = parts.map(p => p.trim());
                    
                    // 验证地址
                    if (!isValidEthereumAddress(address)) {
                        invalidLines.push({line: index + 1, content: line, reason: '无效的以太坊地址'});
                        return;
                    }
                    
                    // 验证金额
                    const amountResult = parseTokenAmount(amountStr, decimals);
                    if (!amountResult.valid) {
                        invalidLines.push({line: index + 1, content: line, reason: '无效的金额: ' + amountResult.error});
                        return;
                    }
                    
                    // 累加总金额
                    totalAmount = totalAmount.add(amountResult.amount);
                    
                    // 添加到任务列表
                    tasks.push({
                        id: index + 1,
                        to: address,
                        amount: amountResult.amount.toString(),
                        amountFormatted: amountStr,
                        status: 'pending', // pending, processing, success, failed
                        txHash: null,
                        error: null
                    });
                });
                
                // 检查是否有无效行
                if (invalidLines.length > 0) {
                    let errorMsg = `有${invalidLines.length}行数据无效:\n`;
                    invalidLines.forEach(item => {
                        errorMsg += `第${item.line}行: ${item.reason}\n`;
                    });
                    showNotification(errorMsg, 'warning');
                    return;
                }
                
                // 检查任务列表
                if (tasks.length === 0) {
                    showNotification('没有有效的分发任务', 'error');
                    return;
                }
                
                // 检查代币余额是否足够
                try {
                    let tokenContract;
                    if (window.currentTokenContract && window.currentTokenContract.options.address.toLowerCase() === tokenAddress.toLowerCase()) {
                        tokenContract = window.currentTokenContract;
                    } else {
                        tokenContract = new web3.eth.Contract(erc20Abi, tokenAddress);
                    }
                    
                    const balance = await tokenContract.methods.balanceOf(currentAccount).call();
                    if (web3.utils.toBN(balance).lt(totalAmount)) {
                        showNotification(`代币余额不足，需要 ${web3.utils.fromWei(totalAmount.toString(), 'ether')}，但只有 ${web3.utils.fromWei(balance, 'ether')}`, 'error');
                        return;
                    }
                    
                    // 确认对话框
                    if (!confirm(`确认向 ${tasks.length} 个地址分发代币?\n总金额: ${totalAmount.div(multiplier).toString()} 代币`)) {
                        return;
                    }
                    
                    // 获取Gas设置
                    const gasPrice = web3.utils.toWei(document.getElementById('gas-price').value, 'gwei');
                    const gasLimit = document.getElementById('gas-limit').value;
                    const autoAdjustGas = document.getElementById('distribute-auto-adjust-gas').checked;
                    const gasAdjustment = parseInt(document.getElementById('distribute-gas-adjustment').value) / 100 + 1; // 转换为乘数
                    
                    // 获取线程数
                    const threadCount = parseInt(document.getElementById('thread-count').value);
                    
                    // 准备进度显示
                    document.getElementById('total-count').textContent = tasks.length;
                    document.getElementById('processed-count').textContent = '0';
                    document.getElementById('success-count').textContent = '0';
                    document.getElementById('failed-count').textContent = '0';
                    document.getElementById('progress-bar').style.width = '0%';
                    document.getElementById('progress-bar').textContent = '0%';
                    document.getElementById('tx-log').innerHTML = '';
                    document.getElementById('distribute-progress').classList.remove('hidden');
                    
                    // 禁用开始按钮
                    this.disabled = true;
                    this.innerHTML = '<span class="loading mr-2"></span>处理中...';
                    
                    // 启动分发任务
                    const distributeResult = await distributeTokens(tokenContract, tasks, {
                        gasPrice,
                        gasLimit,
                        autoAdjustGas,
                        gasAdjustment,
                        threadCount
                    });
                    
                    // 完成后恢复按钮状态
                    this.disabled = false;
                    this.textContent = '开始分发';
                    
                    // 显示结果摘要
                    if (distributeResult.success === tasks.length) {
                        showNotification(`所有 ${tasks.length} 笔交易已成功完成`, 'success');
                    } else {
                        showNotification(`完成: ${distributeResult.success} 成功, ${distributeResult.failed} 失败`, 
                            distributeResult.failed > 0 ? 'warning' : 'success');
                    }
                    
                } catch (error) {
                    console.error('启动分发任务失败:', error);
                    showNotification('启动分发任务失败: ' + error.message, 'error');
                    
                    // 恢复按钮状态
                    this.disabled = false;
                    this.textContent = '开始分发';
                }
            });
            
            // 代币分发执行函数
            async function distributeTokens(tokenContract, tasks, options) {
                // 初始化计数器
                let processedCount = 0;
                let successCount = 0;
                let failedCount = 0;
                
                // 更新进度函数
                function updateProgress() {
                    processedCount++;
                    const progressPercent = Math.floor((processedCount / tasks.length) * 100);
                    document.getElementById('processed-count').textContent = processedCount;
                    document.getElementById('success-count').textContent = successCount;
                    document.getElementById('failed-count').textContent = failedCount;
                    document.getElementById('progress-bar').style.width = `${progressPercent}%`;
                    document.getElementById('progress-bar').textContent = `${progressPercent}%`;
                }
                
                // 添加日志条目
                async function addLogEntry(task, success, message) {
                    const logContainer = document.getElementById('tx-log');
                    const logEntry = document.createElement('div');
                    logEntry.className = `mb-1 p-1 rounded ${success ? 'bg-green-100' : 'bg-red-100'}`;
                    
                    let logText = `#${task.id}: ${formatAddress(task.to)} - ${task.amountFormatted} 代币`;
                    
                    // 如果有交易哈希，添加链接
                    if (task.txHash) {
                        // 获取当前网络ID
                        try {
                            const networkId = await web3.eth.net.getId();
                            let baseUrl = 'https://etherscan.io'; // 默认以太坊主网
                            
                            // 根据网络ID设置正确的区块浏览器URL
                            switch (parseInt(networkId)) {
                                case 1: baseUrl = 'https://etherscan.io'; break;
                                case 5: baseUrl = 'https://goerli.etherscan.io'; break;
                                case 11155111: baseUrl = 'https://sepolia.etherscan.io'; break;
                                case 56: baseUrl = 'https://bscscan.com'; break;
                                case 97: baseUrl = 'https://testnet.bscscan.com'; break;
                                case 137: baseUrl = 'https://polygonscan.com'; break;
                                case 80001: baseUrl = 'https://mumbai.polygonscan.com'; break;
                                case 43114: baseUrl = 'https://snowtrace.io'; break;
                                case 42161: baseUrl = 'https://arbiscan.io'; break;
                                case 10: baseUrl = 'https://optimistic.etherscan.io'; break;
                                // 可以根据需要添加更多网络
                            }
                            
                            logText += ` <a href="#" class="text-blue-600 hover:underline" onclick="window.open('${baseUrl}/tx/${task.txHash}', '_blank'); return false;">查看交易</a>`;
                        } catch (error) {
                            console.error('获取网络ID失败:', error);
                            // 如果获取网络ID失败，使用默认的Etherscan链接
                            logText += ` <a href="#" class="text-blue-600 hover:underline" onclick="window.open('https://etherscan.io/tx/${task.txHash}', '_blank'); return false;">查看交易</a>`;
                        }
                    }
                    
                    if (message) {
                        logText += ` - ${message}`;
                    }
                    
                    logEntry.innerHTML = logText;
                    logContainer.appendChild(logEntry);
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
                
                // 处理单个任务
                async function processTask(task) {
                    try {
                        task.status = 'processing';
                        
                        // 准备交易参数
                        const txParams = {
                            from: currentAccount,
                            gasPrice: options.gasPrice,
                            gas: options.gasLimit
                        };
                        
                        // 如果启用了自动Gas调整，根据网络拥堵情况调整Gas价格
                        if (options.autoAdjustGas) {
                            const currentGasPrice = await web3.eth.getGasPrice();
                            txParams.gasPrice = Math.floor(parseInt(currentGasPrice) * options.gasAdjustment).toString();
                        }
                        
                        // 发送交易
                        const tx = await tokenContract.methods.transfer(task.to, task.amount).send(txParams);
                        
                        // 更新任务状态
                        task.status = 'success';
                        task.txHash = tx.transactionHash;
                        successCount++;
                        
                        // 添加日志
                        await addLogEntry(task, true, '成功');
                        
                        // 添加交易详情链接
                        try {
                            const etherscanUrl = await getEtherscanUrl(tx.transactionHash);
                            if (etherscanUrl) {
                                console.log(`交易成功: ${etherscanUrl}`);
                            }
                        } catch (error) {
                            console.error('获取交易链接失败:', error);
                        }
                    } catch (error) {
                        // 更新任务状态
                        task.status = 'failed';
                        task.error = error.message || '交易失败';
                        failedCount++;
                        
                        // 添加日志
                        await addLogEntry(task, false, `失败: ${task.error}`);
                        console.error(`任务 #${task.id} 失败:`, error);
                    }
                    
                    // 更新进度
                    updateProgress();
                }
                
                // 使用Promise.all和分批执行来实现并发控制
                const pendingTasks = [...tasks];
                const activeTasks = [];
                
                // 开始初始批次的任务
                const startInitialTasks = Math.min(options.threadCount, pendingTasks.length);
                for (let i = 0; i < startInitialTasks; i++) {
                    const task = pendingTasks.shift();
                    activeTasks.push(processTask(task));
                }
                
                // 持续处理队列中的任务
                while (pendingTasks.length > 0) {
                    // 等待任意一个任务完成
                    await Promise.race(activeTasks);
                    
                    // 找到并移除已完成的任务
                    const completedIndex = await Promise.race(
                        activeTasks.map((promise, index) => 
                            promise.then(() => index).catch(() => index)
                        )
                    );
                    activeTasks.splice(completedIndex, 1);
                    
                    // 添加新任务
                    if (pendingTasks.length > 0) {
                        const task = pendingTasks.shift();
                        activeTasks.push(processTask(task));
                    }
                }
                
                // 等待所有剩余任务完成
                await Promise.all(activeTasks);
                
                // 返回结果摘要
                return {
                    total: tasks.length,
                    success: successCount,
                    failed: failedCount
                };
            }
        }
        
        // 初始化代币集中区事件
        function initCollectEvents() {
            // 全局变量
            let collectTokenContract = null;
            let collectTokenDecimals = 18;
            let collectTokenSymbol = '';
            let collectWorkers = [];
            let isCollectProcessing = false;
            
            // 检查代币按钮
            document.getElementById('check-collect-token').addEventListener('click', async function() {
                const tokenAddress = document.getElementById('collect-token-address').value.trim();
                
                // 验证地址格式
                if (!tokenAddress || !web3.utils.isAddress(tokenAddress)) {
                    showNotification('请输入有效的代币合约地址', 'error');
                    return;
                }
                
                // 检查钱包连接状态
                if (!currentAccount) {
                    showNotification('请先连接钱包', 'warning');
                    return;
                }
                
                // 显示加载状态
                const originalText = this.textContent;
                this.innerHTML = '<span class="loading mr-2"></span>检查中...';
                this.disabled = true;
                
                try {
                    // 创建ERC20代币合约实例
                    const tokenContract = new web3.eth.Contract(erc20Abi, tokenAddress);
                    
                    // 并行获取代币信息
                    const [name, symbol, decimalsResult] = await Promise.all([
                        tokenContract.methods.name().call(),
                        tokenContract.methods.symbol().call(),
                        tokenContract.methods.decimals().call()
                    ]);
                    
                    // 保存代币精度和符号
                    collectTokenDecimals = parseInt(decimalsResult);
                    collectTokenSymbol = symbol;
                    
                    // 更新UI显示
                    document.getElementById('collect-token-name').textContent = name;
                    document.getElementById('collect-token-symbol').textContent = symbol;
                    
                    // 显示代币信息区域
                    document.getElementById('collect-token-info').classList.remove('hidden');
                    
                    // 保存当前代币合约实例供后续使用
                    collectTokenContract = tokenContract;
                    
                    showNotification(`成功获取代币 ${name} (${symbol}) 信息`, 'success');
                } catch (error) {
                    console.error('获取代币信息失败:', error);
                    showNotification('获取代币信息失败: ' + (error.message || '无效的ERC20代币合约'), 'error');
                } finally {
                    // 恢复按钮状态
                    this.innerHTML = originalText;
                    this.disabled = false;
                }
            });
            
            // 清空地址列表按钮
            document.getElementById('clear-collect-addresses').addEventListener('click', function() {
                document.getElementById('collect-addresses').value = '';
            });
            
            // 从文件导入按钮
            document.getElementById('import-collect-from-file').addEventListener('click', function() {
                document.getElementById('collect-address-file').click();
            });
            
            // 导入类型选择变化
            document.querySelectorAll('input[name="import-type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    // 隐藏所有导入部分
                    document.querySelectorAll('.import-section').forEach(section => {
                        section.classList.add('hidden');
                    });
                    
                    // 显示选中的导入部分
                    if (this.value === 'private-keys') {
                        document.getElementById('private-keys-input').classList.remove('hidden');
                    } else if (this.value === 'mnemonic') {
                        document.getElementById('mnemonic-input').classList.remove('hidden');
                    }
                });
            });
            
            // 生成地址按钮
            document.getElementById('generate-addresses').addEventListener('click', async function() {
                const mnemonicPhrase = document.getElementById('mnemonic-phrase').value.trim();
                if (!mnemonicPhrase) {
                    showNotification('请输入助记词', 'error');
                    return;
                }
                
                // 验证助记词
                if (!bip39.validateMnemonic(mnemonicPhrase)) {
                    showNotification('无效的助记词', 'error');
                    return;
                }
                
                const password = document.getElementById('mnemonic-password').value;
                const basePath = document.getElementById('derivation-path').value.trim();
                const addressCount = parseInt(document.getElementById('address-count').value);
                
                if (isNaN(addressCount) || addressCount < 1 || addressCount > 100) {
                    showNotification('请输入1-100之间的地址数量', 'error');
                    return;
                }
                
                // 显示加载状态
                const originalText = this.textContent;
                this.innerHTML = '<span class="loading mr-2"></span>生成中...';
                this.disabled = true;
                
                try {
                    // 从助记词生成种子
                    const seed = await new Promise((resolve) => {
                        const seedBytes = bip39.mnemonicToSeedSync(mnemonicPhrase, password);
                        resolve(seedBytes);
                    });
                    
                    // 创建HD钱包
                    const hdwallet = hdkey.fromMasterSeed(seed);
                    const addresses = [];
                    
                    // 生成指定数量的地址
                    for (let i = 0; i < addressCount; i++) {
                        const path = `${basePath}${i}`;
                        const wallet = hdwallet.derive(path);
                        const privateKey = wallet._privateKey.toString('hex');
                        
                        // 创建Web3账户
                        const account = web3.eth.accounts.privateKeyToAccount('0x' + privateKey);
                        const address = account.address;
                        
                        addresses.push({
                            index: i,
                            path: path,
                            address: address,
                            privateKey: '0x' + privateKey
                        });
                    }
                    
                    // 显示生成的地址
                    const addressesListElement = document.getElementById('generated-addresses-list');
                    addressesListElement.innerHTML = '';
                    
                    addresses.forEach(item => {
                        const addressElement = document.createElement('div');
                        addressElement.className = 'py-1 border-b border-gray-200';
                        addressElement.innerHTML = `
                            <div class="flex justify-between items-center">
                                <span>${item.path}: ${formatAddress(item.address)}</span>
                                <button class="text-xs bg-gray-200 hover:bg-gray-300 px-1 py-0.5 rounded copy-address" data-address="${item.address}">复制</button>
                            </div>
                        `;
                        addressesListElement.appendChild(addressElement);
                    });
                    
                    // 添加复制按钮事件
                    document.querySelectorAll('.copy-address').forEach(button => {
                        button.addEventListener('click', function() {
                            const address = this.getAttribute('data-address');
                            navigator.clipboard.writeText(address)
                                .then(() => showNotification('地址已复制', 'success'))
                                .catch(err => showNotification('复制失败: ' + err, 'error'));
                        });
                    });
                    
                    // 存储生成的地址和私钥
                    window.generatedAddresses = addresses;
                    
                    // 显示生成的地址容器
                    document.getElementById('generated-addresses-container').classList.remove('hidden');
                    
                    showNotification(`成功生成${addresses.length}个地址`, 'success');
                } catch (error) {
                    console.error('生成地址失败:', error);
                    showNotification('生成地址失败: ' + error.message, 'error');
                } finally {
                    // 恢复按钮状态
                    this.innerHTML = originalText;
                    this.disabled = false;
                }
            });
            
            // 使用生成的地址按钮
            document.getElementById('use-generated-addresses').addEventListener('click', function() {
                if (!window.generatedAddresses || window.generatedAddresses.length === 0) {
                    showNotification('没有可用的生成地址', 'error');
                    return;
                }
                
                // 将生成的地址和私钥格式化为地址,私钥格式
                const addressLines = window.generatedAddresses.map(item => 
                    `${item.address},${item.privateKey}`
                );
                
                // 更新私钥输入区域
                const textarea = document.getElementById('collect-addresses');
                const currentContent = textarea.value.trim();
                
                if (currentContent) {
                    textarea.value = currentContent + '\n' + addressLines.join('\n');
                } else {
                    textarea.value = addressLines.join('\n');
                }
                
                // 切换回私钥输入模式
                document.getElementById('import-private-keys').checked = true;
                document.getElementById('private-keys-input').classList.remove('hidden');
                document.getElementById('mnemonic-input').classList.add('hidden');
                
                showNotification(`已添加${window.generatedAddresses.length}个地址到列表`, 'success');
            });
            
            // 文件选择变化
            document.getElementById('collect-address-file').addEventListener('change', function(e) {
                if (!e.target.files || e.target.files.length === 0) {
                    return;
                }
                
                const file = e.target.files[0];
                const fileType = file.name.split('.').pop().toLowerCase();
                
                // 检查文件类型
                if (fileType !== 'txt' && fileType !== 'csv') {
                    showNotification('请选择.txt或.csv格式的文件', 'error');
                    return;
                }
                
                // 显示正在处理通知
                showNotification('正在读取文件...', 'info');
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const content = event.target.result;
                        const lines = content.split(/\r?\n/).filter(line => line.trim());
                        
                        // 验证和解析每一行
                        const validLines = [];
                        const invalidLines = [];
                        
                        lines.forEach((line, index) => {
                            // 尝试解析地址和私钥
                            const parts = line.trim().split(',');
                            
                            if (parts.length !== 2) {
                                invalidLines.push({line: index + 1, content: line, reason: '格式错误，应为"地址,私钥"'});
                                return;
                            }
                            
                            const [address, privateKey] = parts.map(p => p.trim());
                            
                            // 验证地址格式
                            if (!isValidEthereumAddress(address)) {
                                invalidLines.push({line: index + 1, content: line, reason: '无效的以太坊地址'});
                                return;
                            }
                            
                            // 验证私钥格式
                            if (!isValidPrivateKey(privateKey)) {
                                invalidLines.push({line: index + 1, content: line, reason: '无效的私钥格式'});
                                return;
                            }
                            
                            // 添加到有效行
                            validLines.push(line);
                        });
                        
                        // 显示结果
                        if (invalidLines.length > 0) {
                            let errorMsg = `文件中有${invalidLines.length}行数据无效:\n`;
                            invalidLines.slice(0, 5).forEach(item => {
                                errorMsg += `第${item.line}行: ${item.reason}\n`;
                            });
                            
                            if (invalidLines.length > 5) {
                                errorMsg += `... 等共${invalidLines.length}个错误`;
                            }
                            
                            showNotification(errorMsg, 'warning');
                        }
                        
                        if (validLines.length > 0) {
                            // 将有效行添加到文本区域
                            const textarea = document.getElementById('collect-addresses');
                            const currentContent = textarea.value.trim();
                            
                            if (currentContent) {
                                textarea.value = currentContent + '\n' + validLines.join('\n');
                            } else {
                                textarea.value = validLines.join('\n');
                            }
                            
                            showNotification(`成功导入${validLines.length}个地址和私钥`, 'success');
                        } else {
                            showNotification('没有找到有效的地址和私钥', 'error');
                        }
                    } catch (error) {
                        console.error('解析文件失败:', error);
                        showNotification('解析文件失败: ' + error.message, 'error');
                    }
                    
                    // 重置文件输入
                    e.target.value = '';
                };
                
                reader.onerror = function() {
                    showNotification('读取文件失败', 'error');
                    e.target.value = '';
                };
                
                reader.readAsText(file);
            });
            
            // 开始集中按钮
            document.getElementById('start-collect').addEventListener('click', async function() {
                // 检查是否已在处理中
                if (isCollectProcessing) {
                    showNotification('已有集中任务正在进行中', 'warning');
                    return;
                }
                
                // 检查代币合约
                if (!collectTokenContract) {
                    showNotification('请先检查代币合约信息', 'warning');
                    return;
                }
                
                // 获取目标地址
                const targetAddress = document.getElementById('target-address').value.trim();
                if (!targetAddress || !web3.utils.isAddress(targetAddress)) {
                    showNotification('请输入有效的目标地址', 'error');
                    return;
                }
                
                // 获取源地址和私钥列表
                const addressesInput = document.getElementById('collect-addresses').value.trim();
                if (!addressesInput) {
                    showNotification('请输入源地址和私钥', 'error');
                    return;
                }
                
                // 解析地址和私钥
                const addressList = [];
                const lines = addressesInput.split('\n');
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const parts = line.split(',');
                    if (parts.length !== 2) {
                        showNotification(`第${i+1}行格式错误: ${line}`, 'error');
                        return;
                    }
                    
                    const [address, privateKey] = parts.map(p => p.trim());
                    
                    // 验证地址
                    if (!isValidEthereumAddress(address)) {
                        showNotification(`第${i+1}行包含无效的地址: ${address}`, 'error');
                        return;
                    }
                    
                    // 验证私钥
                    if (!isValidPrivateKey(privateKey)) {
                        showNotification(`第${i+1}行包含无效的私钥`, 'error');
                        return;
                    }
                    
                    addressList.push({address, privateKey});
                }
                
                if (addressList.length === 0) {
                    showNotification('没有找到有效的地址和私钥', 'error');
                    return;
                }
                
                // 获取Gas设置
                const gasPrice = web3.utils.toWei(
                    document.getElementById('collect-gas-price').value, 
                    'gwei'
                );
                const gasLimit = document.getElementById('collect-gas-limit').value;
                
                // 是否集中全部代币
                const collectAll = document.getElementById('collect-all-tokens').checked;
                
                // 显示进度UI
                document.getElementById('collect-progress').classList.remove('hidden');
                document.getElementById('collect-progress-bar').style.width = '0%';
                document.getElementById('collect-progress-bar').textContent = '0%';
                document.getElementById('collect-processed-count').textContent = '0';
                document.getElementById('collect-total-count').textContent = addressList.length;
                document.getElementById('collect-success-count').textContent = '0';
                document.getElementById('collect-failed-count').textContent = '0';
                document.getElementById('collect-tx-log').innerHTML = '';
                
                // 禁用按钮
                this.disabled = true;
                this.innerHTML = '<span class="loading mr-2"></span>处理中...';
                isCollectProcessing = true;
                
                // 清理之前的工作线程
                collectWorkers.forEach(worker => worker.terminate());
                collectWorkers = [];
                
                // 计数器
                let processed = 0;
                let success = 0;
                let failed = 0;
                
                // 更新进度函数
                function updateProgress() {
                    const percent = Math.floor((processed / addressList.length) * 100);
                    document.getElementById('collect-progress-bar').style.width = percent + '%';
                    document.getElementById('collect-progress-bar').textContent = percent + '%';
                    document.getElementById('collect-processed-count').textContent = processed;
                    document.getElementById('collect-success-count').textContent = success;
                    document.getElementById('collect-failed-count').textContent = failed;
                }
                
                // 添加日志函数
                function addLog(message, type = 'info') {
                    const logElement = document.getElementById('collect-tx-log');
                    const logEntry = document.createElement('div');
                    logEntry.className = 'py-1 border-b border-gray-200';
                    
                    let textClass = 'text-gray-700';
                    if (type === 'success') textClass = 'text-green-600';
                    if (type === 'error') textClass = 'text-red-600';
                    if (type === 'warning') textClass = 'text-yellow-600';
                    
                    logEntry.innerHTML = `<span class="${textClass}">${message}</span>`;
                    logElement.appendChild(logEntry);
                    logElement.scrollTop = logElement.scrollHeight;
                }
                
                // 处理单个地址的函数
                async function processAddress(item, index) {
                    try {
                        // 创建新的Web3实例，避免冲突
                        const localWeb3 = new Web3(web3.currentProvider);
                        
                        // 使用私钥创建账户
                        const account = localWeb3.eth.accounts.privateKeyToAccount(item.privateKey);
                        
                        // 获取账户代币余额
                        const balance = await collectTokenContract.methods.balanceOf(item.address).call();
                        
                        // 如果余额为0，跳过
                        if (balance === '0') {
                            addLog(`地址 ${formatAddress(item.address)} 代币余额为0，跳过`, 'warning');
                            return { success: false, skipped: true };
                        }
                        
                        // 获取要转账的金额
                        const amount = collectAll ? balance : '0'; // 实际应用中应根据需求设置
                        
                        // 创建转账交易数据
                        const txData = collectTokenContract.methods.transfer(targetAddress, amount).encodeABI();
                        
                        // 获取nonce
                        const nonce = await localWeb3.eth.getTransactionCount(item.address, 'pending');
                        
                        // 创建交易对象
                        const txObject = {
                            from: item.address,
                            to: collectTokenContract.options.address,
                            data: txData,
                            gas: gasLimit,
                            gasPrice: gasPrice,
                            nonce: nonce
                        };
                        
                        // 签名交易
                        const signedTx = await account.signTransaction(txObject);
                        
                        // 发送交易
                        const receipt = await localWeb3.eth.sendSignedTransaction(signedTx.rawTransaction);
                        
                        // 计算转账的代币数量
                        const tokenAmount = localWeb3.utils.fromWei(amount, 'ether');
                        
                        addLog(`成功: ${formatAddress(item.address)} -> ${formatAddress(targetAddress)} ${tokenAmount} ${collectTokenSymbol} (${receipt.transactionHash.substring(0, 10)}...)`, 'success');
                        
                        return { success: true, receipt };
                    } catch (error) {
                        console.error(`处理地址 ${item.address} 失败:`, error);
                        addLog(`失败: ${formatAddress(item.address)} - ${error.message}`, 'error');
                        return { success: false, error };
                    }
                }
                
                // 获取并发线程数
                const threadCount = parseInt(document.getElementById('thread-count') ? document.getElementById('thread-count').value : 3);
                const batchSize = Math.max(1, Math.min(10, threadCount)); // 确保在1-10之间
                const results = [];
                
                // 显示并发数量
                addLog(`使用 ${batchSize} 个并发线程处理`, 'info');
                
                // 获取gas调整设置
                const autoAdjustGas = document.getElementById('collect-auto-adjust-gas').checked;
                const gasAdjustment = parseInt(document.getElementById('collect-gas-adjustment').value) || 0;
                
                if (gasAdjustment !== 0) {
                    const adjustedGasPrice = calculateAdjustedGasPrice(gasPrice, gasAdjustment);
                    addLog(`已将Gas价格调整 ${gasAdjustment}%: ${web3.utils.fromWei(adjustedGasPrice, 'gwei')} Gwei`, 'info');
                }
                
                try {
                    // 在开始处理前获取每个地址的代币余额
                    addLog('正在获取所有地址的代币余额...', 'info');
                    
                    // 并行获取所有地址的余额
                    const balancePromises = addressList.map(item => 
                        collectTokenContract.methods.balanceOf(item.address).call()
                            .then(balance => ({ address: item.address, balance }))
                            .catch(error => ({ address: item.address, balance: '0', error }))
                    );
                    
                    const balanceResults = await Promise.all(balancePromises);
                    
                    // 过滤出有余额的地址
                    const addressesWithBalance = [];
                    let totalTokens = web3.utils.toBN('0');
                    
                    for (const result of balanceResults) {
                        const balanceBN = web3.utils.toBN(result.balance);
                        if (balanceBN.gt(web3.utils.toBN('0'))) {
                            const address = addressList.find(a => a.address === result.address);
                            if (address) {
                                addressesWithBalance.push({
                                    ...address,
                                    balance: result.balance
                                });
                                totalTokens = totalTokens.add(balanceBN);
                            }
                        }
                    }
                    
                    // 显示余额信息
                    const totalTokensFormatted = web3.utils.fromWei(totalTokens.toString(), 'ether');
                    addLog(`找到 ${addressesWithBalance.length} 个有余额的地址，共 ${totalTokensFormatted} ${collectTokenSymbol}`, 'info');
                    
                    if (addressesWithBalance.length === 0) {
                        showNotification('没有找到有余额的地址，操作已取消', 'warning');
                        document.getElementById('start-collect').disabled = false;
                        document.getElementById('start-collect').textContent = '开始集中';
                        isCollectProcessing = false;
                        return;
                    }
                    
                    // 更新总计数
                    document.getElementById('collect-total-count').textContent = addressesWithBalance.length;
                    
                    // 分批处理
                    for (let i = 0; i < addressesWithBalance.length; i += batchSize) {
                        // 如果启用了自动调整Gas，在每批次前检查网络状态
                        if (autoAdjustGas && i > 0) {
                            try {
                                // 这里可以添加实际的gas价格获取逻辑
                                // 模拟获取当前Gas价格
                                const currentGasPrice = await new Promise(resolve => {
                                    setTimeout(() => {
                                        // 模拟网络拥堵情况下的Gas价格波动
                                        const fluctuation = Math.random() * 0.4 - 0.2; // -20% 到 +20% 的波动
                                        const newGasPrice = web3.utils.toBN(gasPrice).muln(1 + fluctuation);
                                        resolve(newGasPrice.toString());
                                    }, 500);
                                });
                                
                                // 调整当前批次的Gas价格
                                const adjustedGasPrice = calculateAdjustedGasPrice(currentGasPrice, gasAdjustment);
                                addLog(`网络状态已更新，调整Gas价格为: ${web3.utils.fromWei(adjustedGasPrice, 'gwei')} Gwei`, 'info');
                            } catch (error) {
                                console.error('获取Gas价格失败:', error);
                                // 继续使用原来的Gas价格
                            }
                        }
                        
                        const batch = addressesWithBalance.slice(i, i + batchSize);
                        
                        // 并行处理每一批
                        const batchPromises = batch.map((item, batchIndex) => 
                            processAddress(item, i + batchIndex)
                                .then(result => {
                                    processed++;
                                    if (result.success) success++;
                                    else if (!result.skipped) failed++;
                                    updateProgress();
                                    return result;
                                })
                        );
                        
                        // 等待当前批次完成
                        const batchResults = await Promise.all(batchPromises);
                        results.push(...batchResults);
                        
                        // 在批次之间添加短暂延迟，避免网络过载
                        if (i + batchSize < addressesWithBalance.length) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                    
                    const successRate = Math.round((success / addressesWithBalance.length) * 100);
                    showNotification(`代币集中完成: 成功 ${success}/${addressesWithBalance.length} (${successRate}%)`, 
                        successRate > 90 ? 'success' : 'warning');
                    
                    // 添加完成日志
                    addLog(`✅ 集中操作完成！成功率: ${successRate}%`, 'success');
                } catch (error) {
                    console.error('代币集中过程中出错:', error);
                    showNotification('代币集中过程中出错: ' + error.message, 'error');
                    addLog(`❌ 出错: ${error.message}`, 'error');
                } finally {
                    // 恢复按钮状态
                    document.getElementById('start-collect').disabled = false;
                    document.getElementById('start-collect').textContent = '开始集中';
                    isCollectProcessing = false;
                }
                
                // 辅助函数：计算调整后的Gas价格
                function calculateAdjustedGasPrice(baseGasPrice, adjustmentPercent) {
                    if (adjustmentPercent === 0) return baseGasPrice;
                    
                    const baseBN = web3.utils.toBN(baseGasPrice);
                    const adjustment = baseBN.muln(Math.abs(adjustmentPercent)).divn(100);
                    
                    if (adjustmentPercent > 0) {
                        return baseBN.add(adjustment).toString();
                    } else {
                        return baseBN.sub(adjustment).toString();
                    }
                }
            });
            
            // 验证以太坊地址
            function isValidEthereumAddress(address) {
                return web3.utils.isAddress(address);
            }
            
            // 验证私钥格式
            function isValidPrivateKey(privateKey) {
                // 私钥应该是64个十六进制字符，可能带有0x前缀
                if (privateKey.startsWith('0x')) {
                    privateKey = privateKey.substring(2);
                }
                
                // 检查长度和格式
                const hexRegex = /^[0-9a-fA-F]{64}$/;
                return hexRegex.test(privateKey);
            }
            
            // 更新线程数显示
            const threadCountSlider = document.getElementById('thread-count');
            if (threadCountSlider) {
                threadCountSlider.addEventListener('input', function() {
                    document.getElementById('thread-count-value').textContent = this.value;
                });
            }
        }
        
        // 初始化合约交互区事件
        function initContractEvents() {
            // 全局变量，用于存储当前解析的ABI和选择的函数
            let currentAbi = null;
            let currentFunction = null;
            let contractHistory = loadContractHistory();
            
            // 交互类型选择变化
            document.querySelectorAll('input[name="interaction-type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'contract') {
                        document.getElementById('contract-interaction-options').classList.remove('hidden');
                        document.getElementById('send-eth-options').classList.add('hidden');
                        document.getElementById('function-selector').closest('.bg-gray-50').classList.remove('hidden');
                        document.getElementById('function-data').closest('.bg-gray-50').classList.remove('hidden');
                    } else if (this.value === 'send-eth') {
                        document.getElementById('contract-interaction-options').classList.add('hidden');
                        document.getElementById('send-eth-options').classList.remove('hidden');
                        document.getElementById('function-selector').closest('.bg-gray-50').classList.add('hidden');
                        document.getElementById('function-data').closest('.bg-gray-50').classList.add('hidden');
                    }
                });
            });
            
            // 合约payable复选框变化
            document.getElementById('contract-payable').addEventListener('change', function() {
                if (this.checked) {
                    document.getElementById('eth-amount-container').classList.remove('hidden');
                } else {
                    document.getElementById('eth-amount-container').classList.add('hidden');
                }
            });
            
            // 合约地址验证
            document.getElementById('contract-address').addEventListener('blur', async function() {
                const address = this.value.trim();
                if (!address) return;
                
                if (!web3.utils.isAddress(address)) {
                    showNotification('无效的合约地址格式', 'error');
                    this.classList.add('border-red-500');
                    return;
                }
                
                try {
                    // 检查地址是否为合约
                    const code = await web3.eth.getCode(address);
                    if (code === '0x' || code === '0x0') {
                        showNotification('该地址不是合约地址', 'warning');
                        this.classList.add('border-yellow-500');
                    } else {
                        showNotification('合约地址有效', 'success');
                        this.classList.remove('border-red-500', 'border-yellow-500');
                        this.classList.add('border-green-500');
                        setTimeout(() => {
                            this.classList.remove('border-green-500');
                        }, 2000);
                    }
                } catch (error) {
                    console.error('验证合约地址失败:', error);
                    showNotification('验证合约地址失败: ' + error.message, 'error');
                }
            });
            
            // 解析ABI按钮
            document.getElementById('parse-abi').addEventListener('click', function() {
                const abiString = document.getElementById('contract-abi').value.trim();
                if (!abiString) {
                    showNotification('请输入合约ABI', 'warning');
                    return;
                }
                
                try {
                    // 解析ABI JSON
                    const abi = JSON.parse(abiString);
                    currentAbi = abi;
                    
                    // 筛选出所有函数
                    const functions = abi.filter(item => 
                        item.type === 'function' || 
                        (item.type === undefined && (item.inputs !== undefined || item.outputs !== undefined))
                    );
                    
                    if (functions.length === 0) {
                        showNotification('未找到函数定义', 'warning');
                        return;
                    }
                    
                    // 更新函数下拉菜单
                    const selectElement = document.getElementById('abi-functions');
                    selectElement.innerHTML = '<option value="">-- 选择函数 --</option>';
                    
                    functions.forEach((func, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        
                        // 构建函数签名
                        const inputs = func.inputs || [];
                        const inputTypes = inputs.map(input => input.type).join(',');
                        const signature = `${func.name}(${inputTypes})`;
                        
                        // 添加状态可变性标记
                        let mutabilityLabel = '';
                        if (func.stateMutability === 'view' || func.constant === true) {
                            mutabilityLabel = ' [只读]';
                        } else if (func.stateMutability === 'pure') {
                            mutabilityLabel = ' [纯函数]';
                        } else if (func.stateMutability === 'payable') {
                            mutabilityLabel = ' [可支付]';
                        }
                        
                        option.textContent = signature + mutabilityLabel;
                        selectElement.appendChild(option);
                    });
                    
                    // 显示函数选择区域
                    document.getElementById('abi-functions-container').classList.remove('hidden');
                    showNotification(`成功解析ABI，找到 ${functions.length} 个函数`, 'success');
                } catch (error) {
                    console.error('解析ABI失败:', error);
                    showNotification('解析ABI失败: ' + error.message, 'error');
                }
            });
            
            // 清除ABI按钮
            document.getElementById('clear-abi').addEventListener('click', function() {
                document.getElementById('contract-abi').value = '';
                document.getElementById('abi-functions').innerHTML = '<option value="">-- 选择函数 --</option>';
                document.getElementById('abi-functions-container').classList.add('hidden');
                document.getElementById('function-params-container').classList.add('hidden');
                document.getElementById('function-params').innerHTML = '';
                currentAbi = null;
                currentFunction = null;
            });
            
            // 函数选择变化
            document.getElementById('abi-functions').addEventListener('change', function() {
                const selectedIndex = this.value;
                if (!selectedIndex || !currentAbi) {
                    document.getElementById('function-params-container').classList.add('hidden');
                    return;
                }
                
                // 获取选中的函数
                const funcIndex = parseInt(selectedIndex);
                const functions = currentAbi.filter(item => 
                    item.type === 'function' || 
                    (item.type === undefined && (item.inputs !== undefined || item.outputs !== undefined))
                );
                
                if (funcIndex < 0 || funcIndex >= functions.length) {
                    showNotification('无效的函数选择', 'error');
                    return;
                }
                
                currentFunction = functions[funcIndex];
                
                // 生成函数参数输入界面
                const paramsContainer = document.getElementById('function-params');
                paramsContainer.innerHTML = '';
                
                const inputs = currentFunction.inputs || [];
                if (inputs.length === 0) {
                    paramsContainer.innerHTML = '<p class="text-sm text-gray-500">此函数没有参数</p>';
                } else {
                    inputs.forEach((input, idx) => {
                        const inputGroup = document.createElement('div');
                        inputGroup.className = 'param-input';
                        
                        const label = document.createElement('label');
                        label.className = 'block text-sm font-medium text-gray-700 mb-1';
                        label.textContent = `${input.name || `参数${idx+1}`} (${input.type})`;
                        
                        const inputElement = document.createElement('input');
                        inputElement.type = 'text';
                        inputElement.className = 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500';
                        inputElement.placeholder = getPlaceholderForType(input.type);
                        inputElement.dataset.type = input.type;
                        inputElement.dataset.name = input.name || `param${idx}`;
                        
                        inputGroup.appendChild(label);
                        inputGroup.appendChild(inputElement);
                        paramsContainer.appendChild(inputGroup);
                    });
                }
                
                // 显示参数输入区域
                document.getElementById('function-params-container').classList.remove('hidden');
                
                // 如果是payable函数，自动选中payable复选框
                if (currentFunction.stateMutability === 'payable') {
                    document.getElementById('contract-payable').checked = true;
                    document.getElementById('eth-amount-container').classList.remove('hidden');
                } else {
                    document.getElementById('contract-payable').checked = false;
                    document.getElementById('eth-amount-container').classList.add('hidden');
                }
                
                // 自动生成函数选择器
                try {
                    const signature = buildFunctionSignature(currentFunction);
                    const selector = web3.utils.sha3(signature).substring(0, 10);
                    document.getElementById('function-selector').value = selector;
                    document.getElementById('function-signature').value = signature;
                } catch (error) {
                    console.error('生成函数选择器失败:', error);
                }
            });
            
            // 编码函数调用按钮
            document.getElementById('encode-function').addEventListener('click', function() {
                if (!currentFunction || !currentAbi) {
                    showNotification('请先选择函数', 'warning');
                    return;
                }
                
                try {
                    // 收集参数值
                    const paramInputs = document.querySelectorAll('#function-params .param-input input');
                    const params = [];
                    
                    paramInputs.forEach(input => {
                        const value = input.value.trim();
                        const type = input.dataset.type;
                        
                        // 根据类型进行转换
                        const convertedValue = convertParamValueByType(value, type);
                        params.push(convertedValue);
                    });
                    
                    // 编码函数调用
                    const functionAbi = [currentFunction];
                    const contractInstance = new web3.eth.Contract(functionAbi);
                    const encodedCall = contractInstance.methods[currentFunction.name](...params).encodeABI();
                    
                    // 分离选择器和数据
                    const selector = encodedCall.substring(0, 10);
                    const data = '0x' + encodedCall.substring(10);
                    
                    // 更新UI
                    document.getElementById('function-selector').value = selector;
                    document.getElementById('function-data').value = data;
                    
                    showNotification('函数调用编码成功', 'success');
                } catch (error) {
                    console.error('编码函数调用失败:', error);
                    showNotification('编码函数调用失败: ' + error.message, 'error');
                }
            });
            
            // 生成选择器按钮
            document.getElementById('generate-selector').addEventListener('click', function() {
                const signature = document.getElementById('function-signature').value.trim();
                if (!signature) {
                    showNotification('请输入函数签名', 'warning');
                    return;
                }
                
                try {
                    // 使用web3计算函数选择器
                    const selector = web3.utils.sha3(signature).substring(0, 10);
                    document.getElementById('function-selector').value = selector;
                    showNotification('函数选择器生成成功', 'success');
                } catch (error) {
                    console.error('生成选择器失败:', error);
                    showNotification('生成选择器失败: ' + error.message, 'error');
                }
            });
            
            // 辅助函数：根据类型生成占位符
            function getPlaceholderForType(type) {
                if (type === 'address') return '0x...';
                if (type.includes('int')) return '123';
                if (type === 'bool') return 'true 或 false';
                if (type === 'string') return '文本';
                if (type.includes('bytes')) return '0x...';
                if (type.includes('[]')) return '[值1,值2,...]';
                return '';
            }
            
            // 辅助函数：根据类型转换参数值
            function convertParamValueByType(value, type) {
                if (!value) return type.includes('[]') ? [] : '';
                
                // 数组类型
                if (type.includes('[]')) {
                    if (value.startsWith('[') && value.endsWith(']')) {
                        try {
                            // 尝试解析JSON数组
                            return JSON.parse(value);
                        } catch (e) {
                            // 如果JSON解析失败，尝试简单的逗号分隔
                            return value.substring(1, value.length - 1).split(',').map(item => item.trim());
                        }
                    } else {
                        return value.split(',').map(item => item.trim());
                    }
                }
                
                // 布尔类型
                if (type === 'bool') {
                    return value.toLowerCase() === 'true';
                }
                
                // 其他类型直接返回
                return value;
            }
            
            // 辅助函数：构建函数签名
            function buildFunctionSignature(funcAbi) {
                const inputs = funcAbi.inputs || [];
                const inputTypes = inputs.map(input => input.type).join(',');
                return `${funcAbi.name}(${inputTypes})`;
            }
            
            // 辅助函数：加载合约交互历史
            function loadContractHistory() {
                try {
                    const history = localStorage.getItem('contractHistory');
                    return history ? JSON.parse(history) : [];
                } catch (error) {
                    console.error('加载交易历史失败:', error);
                    return [];
                }
            }
            
            // 辅助函数：保存合约交互历史
            function saveContractHistory(history) {
                try {
                    // 限制历史记录数量，最多保存50条
                    if (history.length > 50) {
                        history = history.slice(0, 50);
                    }
                    localStorage.setItem('contractHistory', JSON.stringify(history));
                } catch (error) {
                    console.error('保存交易历史失败:', error);
                }
            }
            
            // 执行合约交互按钮
            document.getElementById('execute-contract').addEventListener('click', async function() {
                // 检查钱包连接状态
                if (!currentAccount) {
                    showNotification('请先连接钱包', 'warning');
                    return;
                }
                
                // 获取交互类型
                const interactionType = document.querySelector('input[name="interaction-type"]:checked').value;
                
                // 禁用按钮，显示加载状态
                const originalText = this.textContent;
                this.innerHTML = '<span class="loading mr-2"></span>处理中...';
                this.disabled = true;
                
                try {
                    // 获取Gas设置
                    const gasPrice = web3.utils.toWei(document.getElementById('gas-price-contract').value, 'gwei');
                    const gasLimit = document.getElementById('gas-limit-contract').value;
                    const autoAdjustGas = document.getElementById('contract-auto-adjust-gas').checked;
                    const gasAdjustment = parseInt(document.getElementById('contract-gas-adjustment').value) / 100 + 1; // 转换为乘数
                    
                    // 准备交易参数
                    const txParams = {
                        from: currentAccount,
                        gasPrice: gasPrice,
                        gas: gasLimit
                    };
                    
                    // 如果启用了自动Gas调整，根据网络拥堵情况调整Gas价格
                    if (autoAdjustGas) {
                        try {
                            const currentGasPrice = await web3.eth.getGasPrice();
                            txParams.gasPrice = Math.floor(parseInt(currentGasPrice) * gasAdjustment).toString();
                            console.log('自动调整Gas价格:', web3.utils.fromWei(txParams.gasPrice, 'gwei'), 'Gwei');
                        } catch (error) {
                            console.error('获取Gas价格失败:', error);
                            // 继续使用用户设置的Gas价格
                        }
                    }
                    
                    let txHash;
                    let txDetails = {};
                    
                    // 根据交互类型执行不同操作
                    if (interactionType === 'contract') {
                        // 合约交互
                        const contractAddress = document.getElementById('contract-address').value.trim();
                        if (!contractAddress) {
                            showNotification('请输入合约地址', 'error');
                            return;
                        }
                        
                        // 验证合约地址格式
                        if (!web3.utils.isAddress(contractAddress)) {
                            showNotification('无效的合约地址格式', 'error');
                            return;
                        }
                        
                        const functionSelector = document.getElementById('function-selector').value.trim();
                        if (!functionSelector) {
                            showNotification('请输入函数选择器', 'error');
                            return;
                        }
                        
                        // 验证函数选择器格式
                        if (!functionSelector.startsWith('0x') || functionSelector.length !== 10) {
                            showNotification('无效的函数选择器格式', 'error');
                            return;
                        }
                        
                        // 获取函数参数数据
                        const functionData = document.getElementById('function-data').value.trim() || '0x';
                        
                        // 验证16进制数据格式
                        if (functionData !== '0x' && (!functionData.startsWith('0x') || !/^0x[0-9a-fA-F]*$/.test(functionData))) {
                            showNotification('无效的16进制数据格式', 'error');
                            return;
                        }
                        
                        // 构建完整的交易数据
                        const data = functionSelector + (functionData.startsWith('0x') ? functionData.substring(2) : functionData);
                        txParams.to = contractAddress;
                        txParams.data = data.startsWith('0x') ? data : '0x' + data;
                        
                        // 如果是payable函数，添加value参数
                        const isPayable = document.getElementById('contract-payable').checked;
                        if (isPayable) {
                            const ethAmount = document.getElementById('eth-amount').value;
                            if (!ethAmount || isNaN(ethAmount) || parseFloat(ethAmount) <= 0) {
                                showNotification('请输入有效的ETH数量', 'error');
                                return;
                            }
                            txParams.value = web3.utils.toWei(ethAmount, 'ether');
                        }
                        
                        // 存储交易详情用于历史记录
                        txDetails = {
                            type: 'contract',
                            address: contractAddress,
                            function: document.getElementById('function-signature').value.trim() || functionSelector,
                            data: txParams.data,
                            value: isPayable ? ethAmount + ' ETH' : '0',
                            timestamp: Date.now()
                        };
                        
                        // 确认对话框
                        if (!confirm(`确认执行合约交互?\n合约地址: ${contractAddress}\n函数: ${txDetails.function}\n${isPayable ? '发送: ' + ethAmount + ' ETH' : ''}`)) {
                            this.innerHTML = originalText;
                            this.disabled = false;
                            return;
                        }
                    } else {
                        // 发送链主币
                        const recipient = document.getElementById('recipient-address').value.trim();
                        if (!recipient) {
                            showNotification('请输入接收地址', 'error');
                            return;
                        }
                        
                        // 验证地址格式
                        if (!web3.utils.isAddress(recipient)) {
                            showNotification('无效的接收地址格式', 'error');
                            return;
                        }
                        
                        const amount = document.getElementById('eth-send-amount').value;
                        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                            showNotification('请输入有效的发送数量', 'error');
                            return;
                        }
                        
                        // 验证余额是否足够
                        const balance = await web3.eth.getBalance(currentAccount);
                        const amountWei = web3.utils.toWei(amount, 'ether');
                        if (web3.utils.toBN(balance).lt(web3.utils.toBN(amountWei))) {
                            showNotification(`余额不足，需要 ${amount} ETH，但只有 ${web3.utils.fromWei(balance, 'ether')} ETH`, 'error');
                            return;
                        }
                        
                        // 获取16进制数据
                        const data = document.getElementById('eth-data').value.trim();
                        if (data && (!data.startsWith('0x') || !/^0x[0-9a-fA-F]*$/.test(data))) {
                            showNotification('无效的16进制数据格式', 'error');
                            return;
                        }
                        
                        // 设置交易参数
                        txParams.to = recipient;
                        txParams.value = amountWei;
                        if (data) {
                            txParams.data = data;
                        }
                        
                        // 存储交易详情用于历史记录
                        txDetails = {
                            type: 'transfer',
                            address: recipient,
                            value: amount + ' ETH',
                            data: data || '0x',
                            timestamp: Date.now()
                        };
                        
                        // 确认对话框
                        if (!confirm(`确认发送链主币?\n接收地址: ${recipient}\n数量: ${amount} ETH${data ? '\n数据: ' + data : ''}`)) {
                            this.innerHTML = originalText;
                            this.disabled = false;
                            return;
                        }
                    }
                    
                    // 显示结果区域
                    document.getElementById('contract-result').classList.remove('hidden');
                    document.getElementById('tx-hash').textContent = '等待交易哈希...';
                    document.getElementById('tx-status').textContent = '处理中...';
                    document.getElementById('return-data').textContent = '-';
                    
                    // 发送交易
                    const receipt = await web3.eth.sendTransaction(txParams);
                    txHash = receipt.transactionHash;
                    
                    // 更新UI显示
                    document.getElementById('tx-hash').textContent = txHash;
                    document.getElementById('tx-status').textContent = '确认中...';
                    
                    // 等待交易确认
                    const confirmations = await waitForConfirmation(txHash);
                    
                    // 更新交易状态
                    document.getElementById('tx-status').textContent = confirmations > 0 ? '已确认' : '处理中';
                    
                    // 获取交易详情
                    const tx = await web3.eth.getTransaction(txHash);
                    const txReceipt = await web3.eth.getTransactionReceipt(txHash);
                    
                    // 显示返回数据
                    if (txReceipt && txReceipt.status) {
                        document.getElementById('tx-status').textContent = '成功';
                        
                        // 如果有返回数据，显示返回数据
                        if (txReceipt.logs && txReceipt.logs.length > 0) {
                            document.getElementById('return-data').textContent = txReceipt.logs.map(log => 
                                `Event: ${log.topics[0]}\n${log.data}`
                            ).join('\n\n');
                        } else {
                            document.getElementById('return-data').textContent = '无返回数据';
                        }
                    } else {
                        document.getElementById('tx-status').textContent = '失败';
                        document.getElementById('return-data').textContent = '交易执行失败';
                    }
                    
                    // 添加到交易历史
                    txDetails.hash = txHash;
                    txDetails.status = txReceipt && txReceipt.status ? 'success' : 'failed';
                    contractHistory.unshift(txDetails);
                    saveContractHistory(contractHistory);
                    
                    // 更新历史记录显示
                    updateTransactionHistory();
                    
                    // 显示成功通知
                    showNotification('交易已提交并确认', 'success');
                    
                } catch (error) {
                    console.error('执行交易失败:', error);
                    showNotification('执行交易失败: ' + error.message, 'error');
                    
                    // 更新UI显示交易失败
                    document.getElementById('tx-status').textContent = '失败';
                    document.getElementById('return-data').textContent = '错误: ' + error.message;
                } finally {
                    // 恢复按钮状态
                    this.innerHTML = originalText;
                    this.disabled = false;
                }
            });
            
            // 清除历史记录按钮
            document.getElementById('clear-history').addEventListener('click', function() {
                if (confirm('确认清除所有交易历史记录？')) {
                    contractHistory = [];
                    saveContractHistory([]);
                    updateTransactionHistory();
                    showNotification('历史记录已清除', 'info');
                }
            });
            
            // 初始化加载交易历史
            updateTransactionHistory();
            
            // 等待交易确认的函数
            async function waitForConfirmation(txHash, maxAttempts = 20) {
                let attempts = 0;
                
                while (attempts < maxAttempts) {
                    try {
                        const receipt = await web3.eth.getTransactionReceipt(txHash);
                        if (receipt && receipt.blockNumber) {
                            // 获取当前区块高度
                            const currentBlock = await web3.eth.getBlockNumber();
                            // 计算确认数
                            const confirmations = currentBlock - receipt.blockNumber + 1;
                            return confirmations;
                        }
                    } catch (error) {
                        console.error('获取交易收据失败:', error);
                    }
                    
                    // 等待一段时间再次尝试
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    attempts++;
                }
                
                return 0; // 未能确认
            }
            
            // 更新交易历史记录显示
            function updateTransactionHistory() {
                const historyContainer = document.getElementById('tx-history');
                
                // 清空现有内容
                historyContainer.innerHTML = '';
                
                // 如果没有历史记录，显示空提示
                if (contractHistory.length === 0) {
                    const emptyRow = document.createElement('tr');
                    emptyRow.className = 'tx-history-empty';
                    emptyRow.innerHTML = '<td colspan="6" class="px-4 py-4 text-center text-gray-500">暂无交易记录</td>';
                    historyContainer.appendChild(emptyRow);
                    return;
                }
                
                // 添加每条历史记录
                contractHistory.forEach((tx, index) => {
                    const row = document.createElement('tr');
                    row.className = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                    
                    // 格式化时间
                    const date = new Date(tx.timestamp);
                    const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
                    
                    // 创建单元格内容
                    row.innerHTML = `
                        <td class="px-4 py-2 border-b">${formattedDate}</td>
                        <td class="px-4 py-2 border-b">${tx.type === 'contract' ? '合约交互' : '发送链主币'}</td>
                        <td class="px-4 py-2 border-b">${formatAddress(tx.address)}</td>
                        <td class="px-4 py-2 border-b">${tx.type === 'contract' ? tx.function.substring(0, 20) + (tx.function.length > 20 ? '...' : '') : tx.value}</td>
                        <td class="px-4 py-2 border-b">
                            <span class="px-2 py-1 rounded-full text-xs ${tx.status === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${tx.status === 'success' ? '成功' : '失败'}
                            </span>
                        </td>
                        <td class="px-4 py-2 border-b">
                            ${tx.hash ? `<a href="#" class="text-blue-600 hover:underline view-tx" data-hash="${tx.hash}">查看</a>` : '-'}
                        </td>
                    `;
                    
                    historyContainer.appendChild(row);
                });
                
                // 添加交易查看事件
                document.querySelectorAll('.view-tx').forEach(link => {
                    link.addEventListener('click', async function(e) {
                        e.preventDefault();
                        const hash = this.getAttribute('data-hash');
                        
                        try {
                            // 获取当前网络ID
                            const networkId = await web3.eth.net.getId();
                            let baseUrl = 'https://etherscan.io'; // 默认以太坊主网
                            
                            // 根据网络ID设置正确的区块浏览器URL
                            switch (parseInt(networkId)) {
                                case 1: baseUrl = 'https://etherscan.io'; break;
                                case 5: baseUrl = 'https://goerli.etherscan.io'; break;
                                case 11155111: baseUrl = 'https://sepolia.etherscan.io'; break;
                                case 56: baseUrl = 'https://bscscan.com'; break;
                                case 97: baseUrl = 'https://testnet.bscscan.com'; break;
                                case 137: baseUrl = 'https://polygonscan.com'; break;
                                case 80001: baseUrl = 'https://mumbai.polygonscan.com'; break;
                                case 43114: baseUrl = 'https://snowtrace.io'; break;
                                case 42161: baseUrl = 'https://arbiscan.io'; break;
                                case 10: baseUrl = 'https://optimistic.etherscan.io'; break;
                                // 可以根据需要添加更多网络
                            }
                            
                            const url = `${baseUrl}/tx/${hash}`;
                            window.open(url, '_blank');
                        } catch (error) {
                            console.error('打开区块浏览器失败:', error);
                            // 如果获取网络ID失败，使用默认的Etherscan链接
                            window.open(`https://etherscan.io/tx/${hash}`, '_blank');
                        }
                    });
                });
            }
        }
        
        // 初始化批量导入区事件
        function initBatchImportEvents() {
            // 数据格式选择变化
            document.getElementById('data-format').addEventListener('change', function() {
                if (this.value === 'custom') {
                    document.getElementById('custom-format-container').classList.remove('hidden');
                } else {
                    document.getElementById('custom-format-container').classList.add('hidden');
                }
            });
            
            // 文件选择变化
            document.getElementById('batch-file').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    document.getElementById('file-list').classList.remove('hidden');
                    
                    const fileList = document.getElementById('selected-files');
                    fileList.innerHTML = '';
                    
                    for (let i = 0; i < e.target.files.length; i++) {
                        const file = e.target.files[i];
                        const li = document.createElement('li');
                        li.textContent = file.name + ' (' + formatFileSize(file.size) + ')';
                        fileList.appendChild(li);
                    }
                }
            });
            
            // 开始导入按钮
            document.getElementById('start-import').addEventListener('click', function() {
                // 导入功能将在这里实现
                alert('批量导入功能将在完整实现中提供');
                document.getElementById('import-result').classList.remove('hidden');
            });
            
            // 复制导入数据按钮
            document.getElementById('copy-imported-data').addEventListener('click', function() {
                // 复制功能将在这里实现
                alert('复制功能将在完整实现中提供');
            });
            
            // 使用导入数据按钮
            document.getElementById('use-imported-data').addEventListener('click', function() {
                // 数据使用功能将在这里实现
                alert('数据使用功能将在完整实现中提供');
            });
            
            // 文件拖放区域设置
            const dropZone = document.querySelector('.border-dashed');
            
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('border-blue-500');
            });
            
            dropZone.addEventListener('dragleave', function() {
                this.classList.remove('border-blue-500');
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('border-blue-500');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('batch-file').files = files;
                    
                    // 触发change事件
                    const event = new Event('change', { bubbles: true });
                    document.getElementById('batch-file').dispatchEvent(event);
                }
            });
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
            else return (bytes / 1048576).toFixed(2) + ' MB';
        }
        
        // 初始化Gas设置事件
        function initGasSettingsEvents() {
            // 获取并更新Gas价格的通用函数
            function refreshGasPrices() {
                try {
                    // 模拟获取Gas价格（实际实现会从网络获取）
                    const slowGas = (Math.random() * 20 + 10).toFixed(2);
                    const mediumGas = (Math.random() * 20 + 30).toFixed(2);
                    const fastGas = (Math.random() * 30 + 50).toFixed(2);
                    
                    // 更新所有模块的Gas价格显示
                    const modules = ['distribute', 'collect', 'contract'];
                    modules.forEach(module => {
                        if (document.getElementById(`${module}-gas-slow`)) {
                            document.getElementById(`${module}-gas-slow`).textContent = slowGas;
                            document.getElementById(`${module}-gas-medium`).textContent = mediumGas;
                            document.getElementById(`${module}-gas-fast`).textContent = fastGas;
                        }
                    });
                    
                    // 显示成功消息
                    console.log('Gas价格已更新');
                    return true;
                } catch (error) {
                    console.error('获取Gas价格失败:', error);
                    return false;
                }
            }
            
            // 为每个模块初始化Gas设置事件
            const modules = ['distribute', 'collect', 'contract'];
            
            modules.forEach(module => {
                // 刷新Gas价格按钮
                const refreshBtn = document.getElementById(`${module}-refresh-gas`);
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', function() {
                        if (refreshGasPrices()) {
                            showNotification('Gas价格已更新', 'success');
                        } else {
                            showNotification('获取Gas价格失败', 'error');
                        }
                    });
                }
                
                // 使用慢速Gas按钮
                const slowBtn = document.getElementById(`${module}-use-gas-slow`);
                if (slowBtn) {
                    slowBtn.addEventListener('click', function() {
                        const gasPrice = document.getElementById(`${module}-gas-slow`).textContent;
                        if (gasPrice !== '-') {
                            if (module === 'contract') {
                                document.getElementById('gas-price-contract').value = gasPrice;
                            } else {
                                document.getElementById(`${module}-gas-price`).value = gasPrice;
                            }
                            showNotification('已设置为慢速Gas价格: ' + gasPrice + ' Gwei', 'info');
                        }
                    });
                }
                
                // 使用中速Gas按钮
                const mediumBtn = document.getElementById(`${module}-use-gas-medium`);
                if (mediumBtn) {
                    mediumBtn.addEventListener('click', function() {
                        const gasPrice = document.getElementById(`${module}-gas-medium`).textContent;
                        if (gasPrice !== '-') {
                            if (module === 'contract') {
                                document.getElementById('gas-price-contract').value = gasPrice;
                            } else {
                                document.getElementById(`${module}-gas-price`).value = gasPrice;
                            }
                            showNotification('已设置为中速Gas价格: ' + gasPrice + ' Gwei', 'info');
                        }
                    });
                }
                
                // 使用快速Gas按钮
                const fastBtn = document.getElementById(`${module}-use-gas-fast`);
                if (fastBtn) {
                    fastBtn.addEventListener('click', function() {
                        const gasPrice = document.getElementById(`${module}-gas-fast`).textContent;
                        if (gasPrice !== '-') {
                            if (module === 'contract') {
                                document.getElementById('gas-price-contract').value = gasPrice;
                            } else {
                                document.getElementById(`${module}-gas-price`).value = gasPrice;
                            }
                            showNotification('已设置为快速Gas价格: ' + gasPrice + ' Gwei', 'info');
                        }
                    });
                }
                
                // Gas调整滑块变化
                const adjustSlider = document.getElementById(`${module}-gas-adjustment`);
                if (adjustSlider) {
                    adjustSlider.addEventListener('input', function() {
                        const value = this.value;
                        document.getElementById(`${module}-gas-adjustment-value`).textContent = value + '%';
                    });
                }
            });
            
            // 初始化所有模块的Gas价格（页面加载时）
            refreshGasPrices();
        }
        
        // 辅助函数：验证以太坊地址
        function isValidEthereumAddress(address) {
            return web3 && web3.utils.isAddress(address);
        }
        
        // 辅助函数：获取交易的区块浏览器URL
        async function getEtherscanUrl(txHash) {
            if (!txHash) return null;
            
            try {
                // 获取当前网络ID
                const id = await web3.eth.net.getId();
                let baseUrl;
                
                // 根据链ID选择合适的区块浏览器
                switch (parseInt(id)) {
                    case 1: // 以太坊主网
                        baseUrl = 'https://etherscan.io';
                        break;
                    case 5: // Goerli测试网
                        baseUrl = 'https://goerli.etherscan.io';
                        break;
                    case 11155111: // Sepolia测试网
                        baseUrl = 'https://sepolia.etherscan.io';
                        break;
                    case 56: // 币安智能链
                        baseUrl = 'https://bscscan.com';
                        break;
                    case 97: // 币安测试网
                        baseUrl = 'https://testnet.bscscan.com';
                        break;
                    case 137: // Polygon
                        baseUrl = 'https://polygonscan.com';
                        break;
                    case 80001: // Mumbai测试网
                        baseUrl = 'https://mumbai.polygonscan.com';
                        break;
                    case 43114: // Avalanche C-Chain
                        baseUrl = 'https://snowtrace.io';
                        break;
                    case 42161: // Arbitrum One
                        baseUrl = 'https://arbiscan.io';
                        break;
                    case 10: // Optimism
                        baseUrl = 'https://optimistic.etherscan.io';
                        break;
                    default:
                        return 'https://etherscan.io/tx/' + txHash; // 默认使用以太坊主网
                }
                
                return `${baseUrl}/tx/${txHash}`;
            } catch (error) {
                console.error('获取网络ID失败:', error);
                return 'https://etherscan.io/tx/' + txHash; // 出错时默认使用以太坊主网
            }
        }
        
        // 辅助函数：验证并解析代币金额
        function parseTokenAmount(amountStr, decimals = 18) {
            try {
                if (!amountStr || amountStr.trim() === '') {
                    throw new Error('金额不能为空');
                }
                
                const multiplier = web3.utils.toBN(10).pow(web3.utils.toBN(decimals));
                let amount;
                
                // 处理小数点
                if (amountStr.includes('.')) {
                    const [whole, fraction = ''] = amountStr.split('.');
                    // 确保小数部分不超过代币精度
                    if (fraction.length > decimals) {
                        throw new Error(`小数位数不能超过${decimals}位`);
                    }
                    const fractionPadded = fraction.padEnd(decimals, '0').slice(0, decimals);
                    amount = web3.utils.toBN(whole).mul(multiplier).add(web3.utils.toBN(fractionPadded));
                } else {
                    amount = web3.utils.toBN(amountStr).mul(multiplier);
                }
                
                if (amount.lte(web3.utils.toBN(0))) {
                    throw new Error('金额必须大于0');
                }
                
                return {
                    valid: true,
                    amount: amount,
                    error: null
                };
            } catch (error) {
                return {
                    valid: false,
                    amount: null,
                    error: error.message || '无效的金额格式'
                };
            }
        }
    </script>
</body>
</html>
